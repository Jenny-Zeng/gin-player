"undefined"!=typeof window&&function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Las=t():e.Las=t()}(this,(function(){return function(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=10)}([function(e,t,i){"use strict";t.a={MEDIA_INFO:"mediaInfo",MP4_SEGMENT:"mp4Segment",SCRIPT_PARSED:"scriptParsed",LOAD_END:"loadEnd",ERROR:"lasError",LEVEL_SWITCH_FAILED:"levelSwitchFailed",LEVEL_SWITCHING:"levelSwitching",LEVEL_SWITCHED:"levelSwitched",MANIFEST_PARSED:"manifestParsed",FLV_HEAD:"flvHead",REPORT:"report",HEARTBEAT:"heartbeat"}},function(e,t,i){"use strict";i.d(t,"b",(function(){return o})),i.d(t,"a",(function(){return n}));function r(e,t){return t&&0!==t.length||(t=[e],e=""),e="las.js-"+(e?"::"+e:""),t.unshift("["+e+"] > "),t}var n=function(e){return e.LEVEL_ERROR="e",e.LEVEL_WARN="w",e.LEVEL_INFO="i",e.LEVEL_DEBUG="d",e.LEVEL_VERBOSE="v",e}(n||{}),o=function(){function e(){}return e.level=function(t){switch(e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=e.ENABLE_DEBUG=e.ENABLE_VERBOSE=!1,t){case n.LEVEL_WARN:e.ENABLE_ERROR=e.ENABLE_WARN=!0;break;case n.LEVEL_INFO:e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=!0;break;case n.LEVEL_DEBUG:e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=e.ENABLE_DEBUG=!0;break;case n.LEVEL_VERBOSE:e.ENABLE_ERROR=e.ENABLE_WARN=e.ENABLE_INFO=e.ENABLE_DEBUG=e.ENABLE_VERBOSE=!0;break;default:e.ENABLE_ERROR=!0}},e.e=function(t){if(e.ENABLE_ERROR){for(var i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];var s=r(t,n);(console.error||console.warn||console.log).apply(console,s)}},e.w=function(t){if(e.ENABLE_WARN){for(var i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];var s=r(t,n);(console.warn||console.log).apply(console,s)}},e.i=function(t){if(e.ENABLE_INFO){for(var i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];var s=r(t,n);(console.info||console.log).apply(console,s)}},e.d=function(t){if(e.ENABLE_DEBUG){for(var i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];var s=r(t,n);(console.debug||console.log).apply(console,s)}},e.v=function(t){if(e.ENABLE_VERBOSE){for(var i=arguments.length,n=new Array(i>1?i-1:0),o=1;o<i;o++)n[o-1]=arguments[o];var s=r(t,n);console.log.apply(console,s)}},e}();o.ENABLE_ERROR=!0,o.ENABLE_WARN=!1,o.ENABLE_INFO=!1,o.ENABLE_DEBUG=!1,o.ENABLE_VERBOSE=!1},function(e,t,i){"use strict";i.d(t,"b",(function(){return r})),i.d(t,"a",(function(){return n}));var r=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e.MSE_ERROR="mseError",e}({}),n=function(e){return e[e.LOAD_ERROR=10]="LOAD_ERROR",e[e.LOAD_ERROR_TIMEOUT=11]="LOAD_ERROR_TIMEOUT",e[e.VIDEO_ERROR=101]="VIDEO_ERROR",e[e.UNSUPPORTED=102]="UNSUPPORTED",e[e.CONFIG_ERROR=103]="CONFIG_ERROR",e[e.MANIFEST_ERROR=104]="MANIFEST_ERROR",e[e.NO_VIDEO=105]="NO_VIDEO",e[e.MEDIASOURCE_ERROR=200]="MEDIASOURCE_ERROR",e[e.ADDSOURCEBUFFER_ERROR=201]="ADDSOURCEBUFFER_ERROR",e[e.SOURCEBUFFER_ERROR=202]="SOURCEBUFFER_ERROR",e[e.ENDOFSTREAM_ERROR=203]="ENDOFSTREAM_ERROR",e[e.APPENDBUFFER_ERROR=204]="APPENDBUFFER_ERROR",e[e.DEMUX_ERROR=301]="DEMUX_ERROR",e[e.REMUX_ERROR=302]="REMUX_ERROR",e[e.REMUX_ALLOC_ERROR=303]="REMUX_ALLOC_ERROR",e}({})},function(e,t,i){"use strict";i.d(t,"c",(function(){return r})),i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return o}));var r=function(e){return e[e.AUDIO=8]="AUDIO",e[e.VIDEO=9]="VIDEO",e[e.SCRIPT=18]="SCRIPT",e}({}),n={FLV_HEAD_LEN:13,FLV_TAG_HEAD_LEN:11,FLV_TAG_SIZE_LEN:4,AVC_KEY_FRAME_CHECK_LEN:2},o=function(){this.tagType=r.VIDEO,this.dataSize=0,this.timestamp=0,this.size=0,this.cts=0,this.frameType=0,this.codecId=0,this.body=null}},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var r=function(e){return e.INIT="init",e.FLV_HEAD="flvHead",e.SET_CODECS="setCodecs",e.FLUSH="flush",e.APPEND_DATA="appendData",e.LOAD_END="loadEnd",e.DESTROY="destroy",e.SET_EXTRA="setExtra",e}({})},function(e,t,i){"use strict";var r,n="object"==typeof Reflect?Reflect:null,o=n&&"function"==typeof n.apply?n.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};r=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,e.exports.once=function(e,t){return new Promise((function(i,r){function n(i){e.removeListener(t,o),r(i)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",n),i([].slice.call(arguments))}m(e,t,o,{once:!0}),"error"!==t&&function(e,t,i){"function"==typeof e.on&&m(e,"error",t,i)}(e,n,{once:!0})}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var u=10;function d(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function h(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function f(e,t,i,r){var n,o,s,a;if(d(i),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),s=o[t]),void 0===s)s=o[t]=i,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[i,s]:[s,i]:r?s.unshift(i):s.push(i),(n=h(e))>0&&s.length>n&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,a=u,console&&console.warn&&console.warn(a)}return e}function _(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function c(e,t,i){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},n=_.bind(r);return n.listener=i,r.wrapFn=n,n}function l(e,t,i){var r=e._events;if(void 0===r)return[];var n=r[t];return void 0===n?[]:"function"==typeof n?i?[n.listener||n]:[n]:i?function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(n):v(n,n.length)}function p(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function v(e,t){for(var i=new Array(t),r=0;r<t;++r)i[r]=e[r];return i}function m(e,t,i,r){if("function"==typeof e.on)r.once?e.once(t,i):e.on(t,i);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function n(o){r.once&&e.removeEventListener(t,n),i(o)}))}}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");u=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return h(this)},a.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var r="error"===e,n=this._events;if(void 0!==n)r=r&&void 0===n.error;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=n[e];if(void 0===u)return!1;if("function"==typeof u)o(u,this,t);else{var d=u.length,h=v(u,d);for(i=0;i<d;++i)o(h[i],this,t)}return!0},a.prototype.addListener=function(e,t){return f(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return f(this,e,t,!0)},a.prototype.once=function(e,t){return d(t),this.on(e,c(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,c(this,e,t)),this},a.prototype.removeListener=function(e,t){var i,r,n,o,s;if(d(t),void 0===(r=this._events))return this;if(void 0===(i=r[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(n=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){s=i[o].listener,n=o;break}if(n<0)return this;0===n?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,n),1===i.length&&(r[e]=i[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,i,r;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0===arguments.length){var n,o=Object.keys(i);for(r=0;r<o.length;++r)"removeListener"!==(n=o[r])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},a.prototype.listeners=function(e){return l(this,e,!0)},a.prototype.rawListeners=function(e){return l(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},a.prototype.listenerCount=p,a.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t,i){"use strict";var r,n,o=(r=navigator.vendor,n=navigator.userAgent,{isSafari:!(!(r&&r.indexOf("Apple")>-1&&n)||n.match("CriOS")),isFirefox:/firefox/i.test(n),isAndroid:/android/i.test(n)});t.a=o},function(e,t,i){"use strict";var r=i(0),n=i(2),o=function(e){return e.video="video",e.audio="audio",e}({}),s={"mp4a.40.2":{1:new Uint8Array([0,200,0,128,35,128]),2:new Uint8Array([33,0,73,144,2,25,0,35,128]),3:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]),4:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]),5:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]),6:new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])},"mp4a.40.5":{1:new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]),2:new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]),3:new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}};function a(e){return 1024e3/e}function u(e,t){return s[e]||(e="mp4a.40.5"),s[e][t]}var d=i(1),h=Math.pow(2,32)-1,f={video:new Uint8Array([0,0,0,45,104,100,108,114,0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audio:new Uint8Array([0,0,0,45,104,100,108,114,0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0])},_=new Uint8Array([0,0,0,24,102,116,121,112,105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]),c=new Uint8Array([0,0,0,16,115,116,116,115,0,0,0,0,0,0,0,0]),l=new Uint8Array([0,0,0,16,115,116,115,99,0,0,0,0,0,0,0,0]),p=new Uint8Array([0,0,0,16,115,116,99,111,0,0,0,0,0,0,0,0]),v=new Uint8Array([0,0,0,20,115,116,115,122,0,0,0,0,0,0,0,0,0,0,0,0]),m=new Uint8Array([0,0,0,36,100,105,110,102,0,0,0,28,100,114,101,102,0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),g=new Uint8Array([0,0,0,20,118,109,104,100,0,0,0,1,0,0,0,0,0,0,0,0]),y=new Uint8Array([0,0,0,16,115,109,104,100,0,0,0,0,0,0,0,0]),b=new Uint8Array([0,0,0,20,98,116,114,116,0,28,156,128,0,45,198,192,0,45,198,192]),E=new Uint8Array([0,0,0,120,109,118,104,100,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]),S=new Uint8Array([0,0,0,104,116,107,104,100,1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0]),R=new Uint8Array([0,0,0,32,116,114,101,120,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]),T=new Uint8Array([0,0,0,44,109,100,104,100,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,0,0,172,68,0,0,0,0,0,0,0,0,85,196,0,0]),L=new Uint8Array([0,0,0,93,115,116,115,100,0,0,0,0,0,0,0,1,0,0,0,77,109,112,52,97,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,16,0,0,0,0,172,68,0,0,0,0,0,41,101,115,100,115,0,0,0,0,3,27,0,1,0,4,19,64,21,0,0,0,0,0,0,0,0,0,0,0,5]),w=new Uint8Array([0,0,0,185,115,116,115,100,0,0,0,0,0,0,0,1,0,0,0,169,97,118,99,49,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,2,208,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),O=new Uint8Array([0,0,0,16,112,97,115,112,0,0,0,1,0,0,0,1]),M=function(){function e(){}return e.moov=function(t){var i=_.byteLength+e._getMoovLen(t),r={data:new Uint8Array(i),offset:0};return r.data.set(_,0),r.offset+=_.byteLength,e._writeMoov(r,t),r.data},e.videoMediaSegment=function(t,i,r,n){var o=8+r.mp4Samples.reduce((function(e,t){return e+t.units.reduce((function(e,t){return e+t.byteLength+4}),0)}),0),s=e._getMediaSegmentData(r,o,n);return e._mediaSegmentHead(s,t,i,r,o,n),r.samples.forEach((function(e){e.units.forEach((function(e){var t=e.byteLength;s.data[s.offset]=t>>24&255,s.data[s.offset+1]=t>>16&255,s.data[s.offset+2]=t>>8&255,s.data[s.offset+3]=255&t,s.data.set(e,s.offset+4),s.offset+=4+t})),delete e.units})),s.data},e.audioMediaSegment=function(t,i,r,n){var o=8+r.mp4Samples.reduce((function(e,t){return e+t.unit.byteLength}),0),s=e._getMediaSegmentData(r,o,n);return e._mediaSegmentHead(s,t,i,r,o,n),r.mp4Samples.forEach((function(e){s.data.set(e.unit,s.offset),s.offset+=e.unit.byteLength,delete e.unit})),s.data},e._getMoovLen=function(t){var i=t.reduce((function(t,i){return t+e._getTrakLen(i)}),0);return 8+E.byteLength+i+e._getMvexLen(t)},e._writeMoov=function(t,i){var r=e._getMoovLen(i);e._writeBoxHead(t,e.types.moov,r),e._writeMvhd(t,i[0].timescale,i[0].duration),i.forEach((function(i){e._writeTrak(t,i)})),e._writeMvex(t,i)},e._getMoofLen=function(e){return 100+17*e},e._mediaSegmentHead=function(t,i,r,n,o,s){s&&(t.data.set(s),t.offset=s.byteLength),e._writeMoof(t,i,r,n),e._writeBoxHead(t,e.types.mdat,o)},e._getMediaSegmentData=function(t,i,r){var n=e._getMoofLen(t.mp4Samples.length);return{data:new Uint8Array(n+i+(r?r.byteLength:0)),offset:0}},e._writeMvhd=function(e,t,i){i*=t;var r=Math.floor(i/(h+1)),n=Math.floor(i%(h+1)),o=E;o[28]=t>>24&255,o[29]=t>>16&255,o[30]=t>>8&255,o[31]=255&t,o[32]=r>>24,o[33]=r>>16&255,o[34]=r>>8&255,o[35]=255&r,o[36]=n>>24,o[37]=n>>16&255,o[38]=n>>8&255,o[39]=255&n,e.data.set(o,e.offset),e.offset+=E.byteLength},e._writeTkhd=function(e,t){var i=t.id,r=t.duration*t.timescale,n=Math.floor(r/(h+1)),o=Math.floor(r%(h+1)),s=0,a=0;t.hasOwnProperty("width")&&(s=t.width),t.hasOwnProperty("height")&&(a=t.height);var u=S;u[28]=i>>24&255,u[29]=i>>16&255,u[30]=i>>8&255,u[31]=255&i,u[36]=n>>24,u[37]=n>>16&255,u[38]=n>>8&255,u[39]=255&n,u[40]=o>>24,u[41]=o>>16&255,u[42]=o>>8&255,u[43]=255&o,u[96]=s>>8&255,u[97]=255&s,u[100]=a>>8&255,u[101]=255&a,e.data.set(u,e.offset),e.offset+=S.byteLength},e._getTrakLen=function(t){return 8+S.byteLength+e._getMdiaLen(t)},e._writeTrak=function(t,i){var r=e._getTrakLen(i);this._writeBoxHead(t,e.types.trak,r),this._writeTkhd(t,i),this._writeMdia(t,i)},e._getMdiaLen=function(t){return 8+T.byteLength+f[t.type].byteLength+e._getMinfLen(t)},e._writeMdia=function(t,i){var r=e._getMdiaLen(i);this._writeBoxHead(t,e.types.mdia,r),this._writeMdhd(t,i.timescale,i.duration),t.data.set(f[i.type],t.offset),t.offset+=f[i.type].byteLength,this._writeMinf(t,i)},e._writeMdhd=function(e,t,i){i*=t;var r=Math.floor(i/(h+1)),n=Math.floor(i%(h+1)),o=T;o[28]=t>>24&255,o[29]=t>>16&255,o[30]=t>>8&255,o[31]=255&t,o[32]=r>>24,o[33]=r>>16&255,o[34]=r>>8&255,o[35]=255&r,o[36]=n>>24,o[37]=n>>16&255,o[38]=n>>8&255,o[39]=255&n,e.data.set(o,e.offset),e.offset+=o.byteLength},e._getMinfLen=function(t){return t.type===o.audio?8+y.byteLength+m.byteLength+e._getStblLen(t):8+g.byteLength+m.byteLength+e._getStblLen(t)},e._writeMinf=function(t,i){if(this._writeBoxHead(t,e.types.minf,e._getMinfLen(i)),"audio"===i.type)return t.data.set(y,t.offset),t.offset+=y.byteLength,t.data.set(m,t.offset),t.offset+=m.byteLength,void this._writeStbl(t,i);t.data.set(g,t.offset),t.offset+=g.byteLength,t.data.set(m,t.offset),t.offset+=m.byteLength,this._writeStbl(t,i)},e._getStblLen=function(e){return 8+this._getStsdLen(e)+c.byteLength+l.byteLength+v.byteLength+p.byteLength},e._writeStbl=function(t,i){var r=this._getStblLen(i);this._writeBoxHead(t,e.types.stbl,r),this._writeStsd(t,i),t.data.set(c,t.offset),t.offset+=c.byteLength,t.data.set(l,t.offset),t.offset+=l.byteLength,t.data.set(v,t.offset),t.offset+=v.byteLength,t.data.set(p,t.offset),t.offset+=p.byteLength},e._getStsdLen=function(t){return t.type===o.audio?e._getMp4aStsdLen(t):e._getAvc1StsdLen(t)},e._writeStsd=function(e,t){t.type!==o.audio?this._writeAvc1Stsd(e,t):this._writeMp4aStsd(e,t)},e._getAvcCLen=function(e){return 15+e.sps.reduce((function(e,t){return e+t.byteLength+2}),0)+e.pps.reduce((function(e,t){return e+t.byteLength+2}),0)},e._getAvc1Len=function(t){return 86+e._getAvcCLen(t)+20+16},e._getAvc1StsdLen=function(e){return 16+this._getAvc1Len(e)},e._writeAvc1Stsd=function(t,i){var r,n,o,s=[],a=[];for(r=0;r<i.sps.length;r++)o=(n=i.sps[r]).byteLength,s.push(o>>>8&255),s.push(255&o),s=s.concat(Array.prototype.slice.call(n));for(r=0;r<i.pps.length;r++)o=(n=i.pps[r]).byteLength,a.push(o>>>8&255),a.push(255&o),a=a.concat(Array.prototype.slice.call(n));var u=this._getAvcCLen(i),d=this._getAvc1Len(i),h=this._getAvc1StsdLen(i),f=w,_=i.width,c=i.height,l=i.pixelRatio[0],p=i.pixelRatio[1];f[0]=h>>24&255,f[1]=h>>16&255,f[2]=h>>8&255,f[3]=255&h,f[16]=d>>24&255,f[17]=d>>16&255,f[18]=d>>8&255,f[19]=255&d,f[48]=_>>8&255,f[49]=255&_,f[50]=c>>8&255,f[51]=255&c,t.data.set(f,t.offset),t.offset+=f.byteLength,this._writeBoxHead(t,e.types.avcC,u);var v=[1,s[3],s[4],s[5],255,224|i.sps.length].concat(s).concat([i.pps.length]).concat(a);t.data.set(v,t.offset),t.offset+=v.length,t.data.set(b,t.offset),t.offset+=b.byteLength;var m=O;m[8]=l>>24,m[9]=l>>16&255,m[10]=l>>8&255,m[11]=255&l,m[12]=p>>24,m[13]=p>>16&255,m[14]=p>>8&255,m[15]=255&p,t.data.set(m,t.offset),t.offset+=m.byteLength},e._getMp4aEsdsLen=function(e){return 33+e.config.length+4},e._getMp4aStsdLen=function(t){return 52+e._getMp4aEsdsLen(t)},e._writeMp4aStsd=function(t,i){var r=i.config.length,n=e._getMp4aEsdsLen(i),o=e._getMp4aStsdLen(i),s=o-16,a=L;a[0]=o>>24&255,a[1]=o>>16&255,a[2]=o>>8&255,a[3]=255&o,a[16]=s>>24&255,a[17]=s>>16&255,a[18]=s>>8&255,a[19]=255&s,a[41]=i.channelCount,a[48]=i.samplerate>>8&255,a[49]=255&i.samplerate,a[52]=n>>24&255,a[53]=n>>16&255,a[54]=n>>8&255,a[55]=255&n,a[65]=23+r,a[70]=15+r,t.data.set(a,t.offset),t.offset+=a.byteLength;var u=[r].concat(i.config).concat([6,1,2]);t.data.set(u,t.offset),t.offset+=u.length},e._getMvexLen=function(e){return 8+e.length*R.byteLength},e._writeMvex=function(t,i){var r=e._getMvexLen(i);this._writeBoxHead(t,e.types.mvex,r),i.forEach((function(i){e._writeTrex(t,i)}))},e._writeTrex=function(e,t){var i=t.id,r=R;r[12]=i>>24,r[13]=i>>16&255,r[14]=i>>8&255,r[15]=255&i,e.data.set(r,e.offset),e.offset+=r.byteLength},e._writeMoof=function(t,i,r,n){var o=n.mp4Samples.length,s=e._getMoofLen(o),a=s-24,u=12+o,d=20+16*o,f=s+8,_=n.id,c=n.mp4Samples||[],l=Math.floor(r/(h+1)),p=Math.floor(r%(h+1));e._writeBoxHead(t,e.types.moof,s),e._writeBoxHead(t,e.types.mfhd,16),t.data[t.offset+4]=i>>24,t.data[t.offset+5]=i>>16&255,t.data[t.offset+6]=i>>8&255,t.data[t.offset+7]=255&i,t.offset+=8,e._writeBoxHead(t,e.types.traf,a),e._writeBoxHead(t,e.types.tfhd,16),t.data[t.offset+4]=_>>24,t.data[t.offset+5]=_>>16&255,t.data[t.offset+6]=_>>8&255,t.data[t.offset+7]=255&_,t.offset+=8,e._writeBoxHead(t,e.types.tfdt,20),t.data[t.offset]=1,t.data[t.offset+4]=l>>24,t.data[t.offset+5]=l>>16&255,t.data[t.offset+6]=l>>8&255,t.data[t.offset+7]=255&l,t.data[t.offset+8]=p>>24,t.data[t.offset+9]=p>>16&255,t.data[t.offset+10]=p>>8&255,t.data[t.offset+11]=255&p,t.offset+=12,e._writeBoxHead(t,e.types.sdtp,u),t.offset+=4,c.forEach((function(e,i){var r=e.flags;t.data[t.offset+i]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy})),t.offset+=o,e._writeBoxHead(t,e.types.trun,d),t.data[t.offset+2]=15,t.data[t.offset+3]=1,t.data[t.offset+4]=o>>>24&255,t.data[t.offset+5]=o>>>16&255,t.data[t.offset+6]=o>>>8&255,t.data[t.offset+7]=255&o,t.data[t.offset+8]=f>>>24&255,t.data[t.offset+9]=f>>>16&255,t.data[t.offset+10]=f>>>8&255,t.data[t.offset+11]=255&f,t.offset+=12,c.forEach((function(e,i){t.data.set([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.len>>>24&255,e.len>>>16&255,e.len>>>8&255,255&e.len,e.flags.isLeading<<2|e.flags.dependsOn,e.flags.isDependedOn<<6|e.flags.hasRedundancy<<4|e.flags.isNonSync,61440&e.flags.degradPrio,15&e.flags.degradPrio,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts],t.offset+16*i)})),t.offset+=16*o},e._writeBoxHead=function(e,t,i){e.data[e.offset]=i>>24&255,e.data[e.offset+1]=i>>16&255,e.data[e.offset+2]=i>>8&255,e.data[e.offset+3]=255&i,e.data.set(t,e.offset+4),e.offset+=8},e}();M.types={avc1:[97,118,99,49],avcC:[97,118,99,67],btrt:[98,116,114,116],dinf:[100,105,110,102],dref:[100,114,101,102],esds:[101,115,100,115],ftyp:[102,116,121,112],hdlr:[104,100,108,114],mdat:[109,100,97,116],mdhd:[109,100,104,100],mdia:[109,100,105,97],mfhd:[109,102,104,100],minf:[109,105,110,102],moof:[109,111,111,102],moov:[109,111,111,118],mp4a:[109,112,52,97],mvex:[109,118,101,120],mvhd:[109,118,104,100],pasp:[112,97,115,112],sdtp:[115,100,116,112],stbl:[115,116,98,108],stco:[115,116,99,111],stsc:[115,116,115,99],stsd:[115,116,115,100],stsz:[115,116,115,122],stts:[115,116,116,115],tfdt:[116,102,100,116],tfhd:[116,102,104,100],traf:[116,114,97,102],trak:[116,114,97,107],trun:[116,114,117,110],trex:[116,114,101,120],tkhd:[116,107,104,100],vmhd:[118,109,104,100],smhd:[115,109,104,100]};var A=M;function k(){return(k=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)({}).hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(null,arguments)}var x=function(){function e(e,t){this.tag="MP4Remuxer",this._eventEmitter=void 0,this._forceFirstIDR=void 0,this._videoTimeReference=void 0,this._videoTimeReferenceInfo=void 0,this._extra=void 0,this._nextAudioPTS=void 0,this._nextVideoDTS=void 0,this._initPTS=void 0,this._videoLastPTS=0,this._audioLastPTS=0,this._videoSampleDuration=40,this._moovs=void 0,this._eventEmitter=e,this._videoTimeReference=!t.gopRemux,this._videoTimeReferenceInfo={},this._forceFirstIDR=navigator.userAgent.toLowerCase().indexOf("chrome")>-1}var t=e.prototype;return t.resetMoov=function(){this._moovs=void 0,this._clearVideoTimeReference()},t.setExtra=function(e){this._extra=e},t.resetTimeStamp=function(){this._initPTS=void 0,this._audioLastPTS=this._videoLastPTS=0},t.getLastPTS=function(){return{video:this._videoLastPTS,audio:this._audioLastPTS}},t.flush=function(){var e,t=this._videoTimeReferenceInfo;return this._videoTimeReference&&t.sample&&(t.track.samples=[t.sample],t.track.sequenceNumber++,t.sample=void 0,e=this._remuxVideo(t.track,!0,!1)),this._clearVideoTimeReference(),e},t.remux=function(e,t,i,n,o){if(void 0===o&&(o=!1),this._moovs||this._initMP4(e,t,i),this._moovs){var s,a;if(e.samples.length&&t.samples.length&&!n&&e.samples[0].pts<t.samples[0].pts){var u=k({},t.samples[0]);u.dts=u.pts=e.samples[0].pts,t.samples.unshift(u)}!n&&t.samples.length&&(t.samples[0].pts=t.samples[0].dts),s=this._remuxAudio(e,n),!(a=this._remuxVideo(t,n,!o))&&o&&this._videoTimeReferenceInfo.sample&&(a=this.flush()),a&&!s&&e.codec&&(s=this._fillEmptyAudio(e,n,a.startPTS,a.endPTS,a.streamDTS));var d=[];s&&d.push(s),a&&d.push(a),d.length&&this._eventEmitter.emit(r.a.MP4_SEGMENT,{segments:d,extra:this._extra})}},t._initMP4=function(e,t,i){var o,s=this._eventEmitter,a=e.samples,u=t.samples,d={},h={};if(e.config&&a.length&&(e.timescale=e.samplerate,h.audio=A.moov([e]),d.audioCodec=e.codec,d.channelCount=e.channelCount,d.audioSampleRate=e.samplerate,d.hasAudio=!0,d.defaultAudioCodec=e.defaultCodec,o=a[0].pts-e.inputTimescale*i),t.sps&&t.pps&&u.length){var f=t.inputTimescale;t.timescale=f,h.video=A.moov([t]),d.videoCodec=t.codec,d.width=t.width,d.height=t.height,d.fps=t.fps,d.profile=t.profile,d.level=t.level,d.chromaFormat=t.chromaFormat,d.hasVideo=!0;var _=u[0].pts-f*i,c=u[0].dts-f*i;o=o?Math.min(o,c):_}d.hasAudio||d.hasVideo?(void 0===this._initPTS&&(this._initPTS=o),this._moovs=h,s.emit(r.a.MEDIA_INFO,d)):s.emit(r.a.ERROR,{type:n.b.MUX_ERROR,details:n.a.DEMUX_ERROR,fatal:!1,info:{reason:"no audio/video samples found"}})},t._remuxVideo=function(e,t,i){if(void 0===i&&(i=!0),e.samples.length){var r=this._initPTS,n=e.timescale,s=e.samples,a=0,u=s.length,d=[],h=this._nextVideoDTS;if(void 0!==r&&0!==u&&0!==n){t&&void 0!==h||(h=s[0].dts),s.forEach((function(e){e.pts=e.pts-r,e.dts=e.dts-r})),s.sort((function(e,t){return e.dts-t.dts||e.pts-t.pts})),this._videoTimeReference&&(this._videoTimeReferenceInfo.track=e,this._videoTimeReferenceInfo.sample&&(u++,s.unshift(this._videoTimeReferenceInfo.sample),this._videoTimeReferenceInfo.sample=void 0),s.length>1&&i&&(this._videoTimeReferenceInfo.sample=s.pop(),u--));var f=s[0],_=Math.max(f.dts,0),c=Math.max(f.pts,0);if(t)Math.round(_-h)&&(c=s[0].pts=c-(_-h),_=s[0].dts=_=h);for(var l=0;l<u;l++){var p,v,m=s[l];if(l<u-1){var g=s[l+1];if(g.dts<=m.dts){var y=g.pts-g.dts;g.dts=m.dts+1,g.pts=g.dts+y}a=g.dts-m.dts}else{var b=e.sampleDuration||this._videoSampleDuration;this._videoTimeReferenceInfo.sample&&(b=this._videoTimeReferenceInfo.sample.dts-m.dts),a=Math.floor(b)}v=Math.round(m.pts-m.dts),p=m.units.reduce((function(e,t){return t.byteLength+4+e}),0),d.push({len:p,units:m.units,duration:a,cts:v,streamDTS:m.streamDTS,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:m.key?2:1,isNonSync:m.key?0:1}})}var E=s[s.length-1];this._nextVideoDTS=E.dts+a;var S=E.pts+a;if(d.length&&this._forceFirstIDR){var R=d[0].flags;R.dependsOn=2,R.isNonSync=0}e.mp4Samples=d;var T={payload:A.videoMediaSegment(e.sequenceNumber++,_,e,this._getMoovByType(o.video)),startPTS:c/n,endPTS:S/n,startDTS:_/n,endDTS:this._nextVideoDTS/n,type:o.video,streamDTS:f.streamDTS/n};return this._videoLastPTS=T.endPTS,this._videoSampleDuration=Math.max(a,1),e.samples=[],e.mp4Samples=[],T}}},t._remuxAudio=function(e,t){if(e.samples.length){var i,r=this._initPTS,n=e.inputTimescale,s=n/e.timescale,h=1024*s,f=[],_=0,c=e.samples,l=this._nextAudioPTS,p=a(e.samplerate);if(void 0!==r&&(c.forEach((function(e){e.pts=e.dts=e.pts-r})),t&&void 0!==l||(l=c[0].pts),void 0!==l)){for(var v=0,m=l;v<c.length;v++){var g=c[v],y=g.unit,b=g.pts,E=Math.round(b-m),S=Math.abs(1e3*E/n);if(E<=-h)d.b.v(this.tag,"drop audio frame. pts: "+b);else{if(E>=h&&S<1e5&&m){var R=Math.round(E/h);d.b.v(this.tag,"fill audio frame. count: "+R+" pts: "+b);for(var T=0;T<R;T++){var L=u(e.defaultCodec||e.codec,e.channelCount);L||(d.b.v(this.tag,"fill copy audio frame"),L=y.subarray()),f.push({len:L.byteLength,unit:L,cts:0,duration:1024,streamDTS:Math.round(g.streamDTS-R*p),flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0}}),_=_||Math.max(m,0),m+=h}}else _=_||b,m+=h;f.push({len:y.byteLength,cts:0,duration:1024,unit:y,streamDTS:g.streamDTS,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0}}),i=b}}if(f.length&&"number"==typeof i){this._nextAudioPTS=l=i+1024*s,e.mp4Samples=f;var w=A.audioMediaSegment(e.sequenceNumber++,_/s,e,this._getMoovByType(o.audio));e.samples=[],e.mp4Samples=[];var O=_/n,M=l/n,k={payload:w,startPTS:O,endPTS:M,startDTS:O,endDTS:M,type:o.audio,streamDTS:f[0].streamDTS/n};return this._audioLastPTS=k.endPTS,k}e.samples=[],e.mp4Samples=[]}}},t._fillEmptyAudio=function(e,t,i,r,n){d.b.v(this.tag,"fill empty Audio");var o=u(e.defaultCodec||e.codec,e.channelCount);if(void 0!==this._initPTS&&o){for(var s=e.inputTimescale,h=(void 0!==this._nextAudioPTS?this._nextAudioPTS:i*s)+this._initPTS,f=r*s+this._initPTS,_=a(e.samplerate),c=Math.ceil((f-h)/_),l=[],p=0;p<c;p++){var v=h+p*_;l.push({unit:o,pts:v,dts:v,streamDTS:Math.round(n*s+p*_)})}return e.samples=l,this._remuxAudio(e,t)}},t._getMoovByType=function(e){var t;return this._moovs&&this._moovs[e]&&(t=this._moovs[e],delete this._moovs[e]),t},t._clearVideoTimeReference=function(){this._videoTimeReferenceInfo={}},e}(),D=i(3),C=i(6),P=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];function I(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,B(r.key),r)}}function B(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}var N=function(){function e(e){this._data=void 0,this._byteIndex=void 0,this._bitIndex=void 0,this._data=e,this._byteIndex=0,this._bitIndex=0}var t,i,r,n=e.prototype;return n.skipBits=function(e){if(this.bitRemaining>e){var t=e%8;this._byteIndex=this._byteIndex+Math.floor(e/8)+Math.floor((this._bitIndex+t)/8),this._bitIndex=(this._bitIndex+t)%8}else this._byteIndex=this._data.byteLength-1,this._bitIndex=7},n.bits=function(e){if(e>32)throw new Error("len must be less 32");var t=this._data[this._byteIndex],i=Math.min(8-this._bitIndex,e),r=e-i;this._bitIndex+=i;var n=t>>8-this._bitIndex&Math.pow(2,i)-1;return 8===this._bitIndex&&(this._bitIndex=0,this._byteIndex++),r?n<<r|this.bits(r):n},n.ue=function(){var e=this._leadingZeroCount();return this.bits(e+1)-1},n.se=function(){var e=this.ue();return Math.pow(-1,e+1)*Math.ceil(e/2)},n._leadingZeroCount=function(){for(var e=this.bitRemaining,t=0;t<e;t++)if(1===this.bits(1))return 0===this._bitIndex?(this._byteIndex--,this._bitIndex=7):this._bitIndex--,t;return 0},t=e,(i=[{key:"bitRemaining",get:function(){return 8*(this._data.byteLength-this._byteIndex)-this._bitIndex}}])&&I(t.prototype,i),r&&I(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(),F=[[1,1],[12,11],[10,11],[16,11],[40,33],[24,11],[20,11],[32,11],[80,33],[18,11],[15,11],[64,33],[160,99],[4,3],[3,2],[2,1]],U={1:"4:2:0",2:"4:2:2",3:"4:4:4"},V={66:"Baseline",77:"Main",88:"Extended",100:"High",110:"High10",122:"High422",244:"High444"},j=[100,110,122,244,44,83,86,118,128,138,144],H=function(){function e(){}return e.parse=function(t){for(var i=new Uint8Array(t.byteLength),r=0,n=0;n<t.byteLength;n++)n>=2&&3===t[n]&&0===t[n-1]&&0===t[n-2]||(i[r]=t[n],r++);var o=new N(i);o.skipBits(8);var s=o.bits(8);o.skipBits(8);var a=o.bits(8);o.ue();var u=1;if(-1!==j.indexOf(s)&&(3===(u=o.ue())&&o.skipBits(1),o.ue(),o.ue(),o.skipBits(1),o.bits(1)))for(var d=3!==u?8:12,h=0;h<d;h++)o.bits(1)&&(h<6?e._skipScalingList(o,16):e._skipScalingList(o,64));o.ue();var f=o.ue();if(0===f)o.ue();else if(1===f){o.bits(1),o.se(),o.se();for(var _=o.ue(),c=0;c<_;c++)o.se()}o.ue(),o.skipBits(1);var l=o.ue(),p=o.ue(),v=o.bits(1);0===v&&o.skipBits(1),o.skipBits(1);var m=0,g=0,y=0,b=0;o.bits(1)&&(m=o.ue(),g=o.ue(),y=o.ue(),b=o.ue());var E=0,S=[1,1];if(o.bits(1)){if(o.bits(1)){var R=o.bits(8);R>0&&R<16?S=F[R-1]:255===R&&(S=[o.bits(8)<<8|o.bits(8),o.bits(8)<<8|o.bits(8)])}if(o.bits(1)&&o.bits(1),o.bits(1)&&(o.bits(4),o.bits(1)&&o.bits(24)),o.bits(1)&&(o.ue(),o.ue()),o.bits(1)){var T=o.bits(32),L=o.bits(32);o.bits(1)&&(E=L/(2*T))}}o=void 0;var w=0,O=0;0===u?(w=1,O=2-v):(w=3===u?1:2,O=(1===u?2:1)*(2-v));var M=16*(l+1),A=16*(p+1)*(2-v);return M-=(m+g)*w,A-=(y+b)*O,{profile:V[s]||"unknown",level:(a/10).toFixed(1),chromaFormat:(u<=3?U[u]:U[1])||"unknown",fps:E,pixelAspectRatio:S,width:M,height:A}},e._skipScalingList=function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.se()+256)%256),i=0===r?i:r},e}();function q(e,t,i){for(var r=new Uint8Array(e,t,i),n=[],o=0,s=r.byteLength;o<s;){if(r[o]<128)n.push(r[o]);else if(r[o]<192);else if(r[o]<224){if(o<s-1&&r[o+1]>>6==2){n.push((31&r[o])<<6|63&r[o+1]),o+=2;continue}}else if(r[o]<240){if(o<s-2&&r[o+1]>>6==2&&r[o+2]>>6==2){n.push((15&r[o])<<12|(63&r[o+1])<<6|63&r[o+2]),o+=3;continue}}else if(r[o]<248&&o<s-3&&r[o+1]>>6==2&&r[o+2]>>6==2&&r[o+3]>>6==2){n.push((7&r[o])<<18|(63&r[o+1])<<12|(63&r[o+2])<<6|63&r[o+3]),o+=4;continue}o++}return String.fromCodePoint.apply(null,n)}var z=function(){function e(){}return e.decode=function(t,i){void 0===i&&(i=0);var r={view:new DataView(t,i),i:0};r.i=0;var n={};try{n[e._read(r)]=e._read(r)}catch(e){}return n},e._read=function(t){var i,r=t.view,n=r.byteLength,o=r.getUint8(t.i);switch(t.i++,o){case 0:return i=r.getFloat64(t.i),t.i+=8,i;case 1:return i=r.getUint8(t.i),t.i++,i;case 2:return e._readString(t);case 3:for(i={};t.i<n-4;){if(e._isObjectEnd(t)){t.i+=3;break}e._readObjProperty(t,i)}return i;case 5:return null;case 8:for(i={},t.i+=4;t.i<n-8;){if(e._isObjectEnd(t)){t.i+=3;break}e._readObjProperty(t,i)}return i;case 10:i=[];var s=r.getUint32(t.i);t.i+=4;for(var a=0;a<s;a++)i.push(e._read(t));return i;case 11:return e._readDate(t);case 12:return e._readLongString(t)}},e._isObjectEnd=function(e){return e.i+2>e.view.byteLength-1||0===e.view.getInt16(e.i)&&9===e.view.getUint8(e.i+2)},e._readObjProperty=function(t,i){var r=e._readString(t),n=e._read(t);i[r]=n},e._readString=function(e){var t,i=e.view.getUint16(e.i);return t=i>0?q(e.view.buffer,e.view.byteOffset+e.i+2,i):"",e.i+=2+i,t},e._readLongString=function(e){var t,i=e.view.getUint32(e.i);return t=i>0?q(e.view.buffer,e.view.byteOffset+e.i+4,i):"",e.i+=4+i,t},e._readDate=function(e){var t=e.view.getFloat64(e.i);e.i+=8;var i=e.view.getInt16(e.i);return e.i+=2,new Date(t+60*i*1e3)},e}(),W=function(){function e(e,t,i){this.tag="FlvDemux",this._eventEmitter=void 0,this._remuxer=void 0,this._naluLengthSize=void 0,this._hasVideo=void 0,this._hasAudio=void 0,this._videoTrack=void 0,this._audioTrack=void 0,this._remuxStat=void 0,this._audioLastDTS=0,this._videoLastDTS=0,this._nonMonotonousTagCache=void 0,this._audioCodec="",this._videoCodec="",this._eventEmitter=e,this._remuxer=t,this._naluLengthSize=4,this._hasVideo=!0,this._hasAudio=!0,this._videoTrack={id:1,type:o.video,codec:"",timescale:1e3,duration:0,samples:[],mp4Samples:[],inputTimescale:1e3,sequenceNumber:0,width:0,height:0,codecWidth:0,codecHeight:0,sps:[],pps:[],pixelRatio:[],profile:"",level:"",chromaFormat:"",fps:0,sampleDuration:0},this._audioTrack={id:2,type:o.audio,codec:"",timescale:1e3,duration:0,samples:[],mp4Samples:[],inputTimescale:1e3,sequenceNumber:0,samplerate:0,channelCount:0,config:[],sampleDuration:0}}var t=e.prototype;return t.append=function(e,t,i){var r=this;this._remuxStat||(this._remuxStat={timeOffset:t,isContinuous:i}),e.length&&(e.forEach((function(e){e.tagType===D.c.VIDEO&&r._hasVideo?r._parseVideoData(e):e.tagType===D.c.AUDIO&&r._hasAudio?r._parseAudioData(e):e.tagType===D.c.SCRIPT&&r._parseScriptTag(e)})),this._remux())},t.setCodecs=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),this._audioCodec=e,this._videoCodec=t},t.flvHead=function(e,t){this._hasAudio=e,this._hasVideo=t},t.destroy=function(){},t.flush=function(){this._remux(!0),this._remuxStat=void 0},t.reset=function(){this._videoTrack.samples=[],this._audioTrack.samples=[],this._audioLastDTS=this._videoLastDTS=0,this._remuxStat=void 0},t._parseScriptTag=function(e){if(e.body){var t=z.decode(e.body.buffer);if(t.timestamp=e.timestamp,t.hasOwnProperty("onMetaData")){var i=t.onMetaData;"number"==typeof i.framerate&&(this._videoTrack.fps=this._videoTrack.fps||i.framerate),d.b.i(this.tag,"Parsed onMetaData")}this._eventEmitter.emit(r.a.SCRIPT_PARSED,t)}},t._parseVideoData=function(e){if(e.body){var t=e.body[0];e.frameType=(240&t)>>>4;var i=15&t;if(7===i){e.codecId=i;var r=e.body[1];if(e.cts=((255&e.body[2])<<16)+((255&e.body[3])<<8)+(255&e.body[4]),0===r)this._parseAVCDecoderConfigurationRecord(e,5);else if(1===r)this._parseAVCVideoData(e,5);else if(2!==r)return void this._onError(n.a.DEMUX_ERROR,"video packet type error: "+r+" ")}else this._onError(n.a.DEMUX_ERROR,"video codec Unsupported: "+i)}},t._parseAVCDecoderConfigurationRecord=function(e,t){if(e.body){var i=this._videoTrack,r=e.body.buffer,o=e.body.byteLength-t,s=new DataView(r,t,o),a=s.getUint8(0),u=s.getUint8(1);if(1===a&&0!==u)if(this._naluLengthSize=1+(3&s.getUint8(4)),3===this._naluLengthSize||4===this._naluLengthSize){var h=31&s.getUint8(5);if(0===h||h>1)this._onError(n.a.DEMUX_ERROR,"H264 SPS count error: "+h);else{for(var f=6,_=[],c=0;c<h;c++){var l=s.getUint16(f);if(f+=2,0!==l){var p=new Uint8Array(r,t+f,l);f+=l,_.push(p);for(var v=H.parse(p),m=p.subarray(1,4),g="avc1.",y=0;y<3;y++){var b=m[y].toString(16);b.length<2&&(b="0"+b),g+=b}!i.codec||i.width===v.width&&i.height===v.height&&g===i.codec||(this._remux(!0),this._remuxer.resetMoov()),i.sps=_,i.width=v.width,i.height=v.height,i.pixelRatio=v.pixelAspectRatio,v.fps&&(i.fps=v.fps),i.codec=g,i.profile=v.profile,i.level=v.level,i.chromaFormat=v.chromaFormat}}var E=s.getUint8(f);if(0===E||E>1)this._onError(n.a.DEMUX_ERROR,"H264 PPS count error: "+E);else{f++,i.pps=[];for(var S=0;S<E;S++){var R=s.getUint16(f);f+=2;var T=new Uint8Array(r,t+f,R);i.pps.push(T),0!==R&&(f+=R)}d.b.v(this.tag,"Parsed AVCDecoderConfigurationRecord"),i.sampleDuration=Math.floor(i.timescale/(i.fps||25))}}}else this._onError(n.a.DEMUX_ERROR,"nalu length size error: "+this._naluLengthSize);else this._onError(n.a.DEMUX_ERROR,"AVCDecoderConfiguration error")}},t._parseAVCVideoData=function(e,t,i){if(void 0===i&&(i=!1),e.body){var r=e.body.buffer,n=e.body.byteLength-t,s=new DataView(r,t,n),a=[],u=0,h=0,f=this._naluLengthSize,_=e.timestamp,c=1===e.frameType;if(!i&&_<=this._videoLastDTS&&this._videoLastDTS>0)return d.b.w(this.tag,"debug Non-monotonous DTS dts:"+_+" last:"+this._videoLastDTS),void this._onNonMonotonous({tag:e,dataOffset:t},o.video);!i&&this._nonMonotonousTagCache&&this._flushNonMonotonousCache(),i&&_<=this._videoLastDTS&&(_=this._videoLastDTS+1);for(var l=_+e.cts;h<n;){if(h+4>=n){d.b.v(this.tag,"ignore nalu. timestamp = "+e.timestamp+", offset = "+h+", dataSize = "+n);break}var p=s.getUint32(h);if(3===f&&(p>>>=8),p>n-f)return void d.b.v(this.tag,"ignore nalu. naluSize > dataSize timestamp "+_);var v=new Uint8Array(r,t+h+4,f+p-4);7===e.codecId&&5===(31&s.getUint8(h+f))&&(c=!0),a.push(v),u+=v.byteLength,h+=f+p}if(a.length){var m=this._videoTrack,g={units:a,length:u,dts:_,cts:e.cts,pts:l,streamDTS:e.timestamp,key:c};1==c&&d.b.w(this.tag,"debug key frame pts:"+l),m.samples.push(g)}this._videoLastDTS=_}},t._parseAudioData=function(e,t){var i;if(void 0===t&&(t=!1),e.body)if(e.body.byteLength<=1)d.b.v(this.tag,"audio packet no payload!");else{var r=this._audioTrack,s=e.body[1];if(0!==s)if(1===s){var a=e.body.subarray(2),u=e.timestamp;if(i=1024e3/r.samplerate,this._audioLastDTS>0){u=this._audioLastDTS+i;var h=e.timestamp-u,f=5*i;if(h>f)u=e.timestamp;else if(!t&&h<-f)return void this._onNonMonotonous({tag:e},o.audio)}!t&&this._nonMonotonousTagCache&&this._flushNonMonotonousCache();var _={unit:a,length:a.byteLength,dts:u,pts:u,streamDTS:e.timestamp};this._audioLastDTS=u,r.samples.push(_)}else d.b.v(this.tag,"Unsupported AAC data type "+s);else{if(e.body.byteLength<4)return;var c=function(e,t,i){if(void 0===i&&(i=""),!(e.byteLength<t+3)){var r=e[t+2]>>>3,n=(7&e[t+2])<<1|e[t+3]>>>7,o=n,s=(120&e[t+3])>>>3,a=[];if(i=i||"mp4a.40."+r,!(n<0||n>=P.length||s<0||s>=8))return C.a.isFirefox?n>=6?(r=5,o=n-3):r=2:C.a.isAndroid?r=2:(r=5,"mp4a.40.29"===i||"mp4a.40.5"===i?o=n-3:"mp4a.40.2"===i&&n>=6&&1===s&&(r=2)),a[0]=r<<3|n>>1&7,a[1]=n<<7&128|s<<3,5===r&&(a[1]=a[1]|o>>1&7,a[2]=(1&o)<<7|8,a[3]=0),{config:a,samplerate:P[n],channelCount:s,codec:"mp4a.40."+r,defaultCodec:i}}}(e.body,0,this._audioCodec);c?(r.config=c.config,r.timescale=r.samplerate=c.samplerate,r.channelCount=c.channelCount,r.codec=c.codec,r.defaultCodec=c.defaultCodec,r.sampleDuration=1024e3/r.samplerate):this._onError(n.a.DEMUX_ERROR,"AudioSpecificConfig parse error")}}},t._onNonMonotonous=function(e,t){this._nonMonotonousTagCache||(this._nonMonotonousTagCache={video:[],audio:[]});var i=this._nonMonotonousTagCache[t];if(i.length>10){this._remuxer.flush();var r=this._remuxer.getLastPTS(),n=r.audio;(0===n||r.video>0&&r.video<n)&&(n=r.video),this._videoTrack.samples=[],this._audioTrack.samples=[],this._audioLastDTS=this._videoLastDTS=0,this._remuxStat={isContinuous:!1,timeOffset:n},this._remuxer.resetMoov(),this._remuxer.resetTimeStamp(),d.b.i(this.tag,"NON_MONOTONOUS reset time"),this._flushNonMonotonousCache()}else i.push(e)},t._flushNonMonotonousCache=function(){if(this._nonMonotonousTagCache){var e=this._nonMonotonousTagCache;for(var t in e)for(var i=e[t];i.length;){var r=i.shift();r&&("video"===t?this._parseAVCVideoData(r.tag,r.dataOffset||0,!0):"audio"===t&&this._parseAudioData(r.tag,!0))}this._nonMonotonousTagCache=void 0}},t._remux=function(e){void 0===e&&(e=!1);var t=this._audioTrack,i=this._videoTrack,r=!0,o=0;if(this._remuxStat&&(r=this._remuxStat.isContinuous,o=this._remuxStat.timeOffset),0!==t.samples.length||0!==i.samples.length){if(e||!(this._hasAudio&&0===t.samples.length||this._hasVideo&&i.samples.length<2))try{this._remuxer.remux(t,i,o,r,e),this._remuxStat=void 0}catch(e){d.b.e(this.tag,e),this._onError(n.a.REMUX_ERROR,e.message)}}else e&&this._remuxer.flush()},t._onError=function(e,t){this._eventEmitter.emit(r.a.ERROR,{type:n.b.MUX_ERROR,details:e,fatal:!0,info:{reason:t}})},e}(),G=function(){function e(e,t,i){this.tag="Flv",this._eventEmitter=void 0,this._config=void 0,this._extraData=void 0,this._demuxer=void 0,this._remuxer=void 0,this._eventEmitter=e,this._config=t,this._extraData=i}var t=e.prototype;return t.init=function(){var e=this._config,t=this._eventEmitter,i=this._remuxer=new x(t,e);this._demuxer=new W(t,i,e),i.setExtra(this._extraData)},t.setCodecs=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),this._demuxer.setCodecs(e,t)},t.flvHead=function(e,t){this._demuxer.flvHead(e,t)},t.append=function(e,t,i){i||(this._demuxer.reset(),this._remuxer.resetMoov(),this._remuxer.resetTimeStamp()),this._demuxer.append(e,t,i)},t.end=function(){this._demuxer.flush(),this._remuxer.flush(),this._eventEmitter.emit(r.a.LOAD_END)},t.flush=function(){this._demuxer&&this._demuxer.flush()},t.setExtra=function(e){this._extraData=e,this._remuxer&&this._remuxer.setExtra(this._extraData)},t.destroy=function(){},e}();t.a=G},function(e,t,i){function r(e){var t={};function i(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="/",i.oe=function(e){throw console.error(e),e};var r=i(i.s=ENTRY_MODULE);return r.default||r}function n(e){return(e+"").replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}function o(e,t,r){var o={};o[r]=[];var s=t.toString(),a=s.match(/^function\s?\w*\(\w+,\s*\w+,\s*(\w+)\)/);if(!a)return o;for(var u,d=a[1],h=new RegExp("(\\\\n|\\W)"+n(d)+"\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)","g");u=h.exec(s);)"dll-reference"!==u[3]&&o[r].push(u[3]);for(h=new RegExp("\\("+n(d)+'\\("(dll-reference\\s([\\.|\\-|\\+|\\w|/|@]+))"\\)\\)\\(\\s*(/\\*.*?\\*/)?\\s*.*?([\\.|\\-|\\+|\\w|/|@]+).*?\\)',"g");u=h.exec(s);)e[u[2]]||(o[r].push(u[1]),e[u[2]]=i(u[1]).m),o[u[2]]=o[u[2]]||[],o[u[2]].push(u[4]);for(var f,_=Object.keys(o),c=0;c<_.length;c++)for(var l=0;l<o[_[c]].length;l++)f=o[_[c]][l],isNaN(1*f)||(o[_[c]][l]=1*o[_[c]][l]);return o}function s(e){return Object.keys(e).reduce((function(t,i){return t||e[i].length>0}),!1)}e.exports=function(e,t){t=t||{};var n={main:i.m},a=t.all?{main:Object.keys(n.main)}:function(e,t){for(var i={main:[t]},r={main:[]},n={main:{}};s(i);)for(var a=Object.keys(i),u=0;u<a.length;u++){var d=a[u],h=i[d].pop();if(n[d]=n[d]||{},!n[d][h]&&e[d][h]){n[d][h]=!0,r[d]=r[d]||[],r[d].push(h);for(var f=o(e,e[d][h],d),_=Object.keys(f),c=0;c<_.length;c++)i[_[c]]=i[_[c]]||[],i[_[c]]=i[_[c]].concat(f[_[c]])}}return r}(n,e),u="";Object.keys(a).filter((function(e){return"main"!==e})).forEach((function(e){for(var t=0;a[e][t];)t++;a[e].push(t),n[e][t]="(function(module, exports, __webpack_require__) { module.exports = __webpack_require__; })",u=u+"var "+e+" = ("+r.toString().replace("ENTRY_MODULE",JSON.stringify(t))+")({"+a[e].map((function(t){return JSON.stringify(t)+": "+n[e][t].toString()})).join(",")+"});\n"})),u=u+"new (("+r.toString().replace("ENTRY_MODULE",JSON.stringify(e))+")({"+a.main.map((function(e){return JSON.stringify(e)+": "+n.main[e].toString()})).join(",")+"}))(self);";var d=new window.Blob([u],{type:"text/javascript"});if(t.bare)return d;var h=(window.URL||window.webkitURL||window.mozURL||window.msURL).createObjectURL(d),f=new window.Worker(h);return f.objectURL=h,f}},function(e,t,i){"use strict";i.r(t);var r=i(5),n=i(0),o=i(4),s=i(1),a=i(7);t.default=function(e){var t,i=new r.EventEmitter;i.on(n.a.MEDIA_INFO,(function(t){e.postMessage({event:n.a.MEDIA_INFO,data:t})})),i.on(n.a.ERROR,(function(t){e.postMessage({event:n.a.ERROR,data:t})})),i.on(n.a.SCRIPT_PARSED,(function(t){e.postMessage({event:n.a.SCRIPT_PARSED,data:t})})),i.on(n.a.LOAD_END,(function(t){e.postMessage({event:n.a.LOAD_END,data:t})})),i.on(n.a.MP4_SEGMENT,(function(t){var i={event:n.a.MP4_SEGMENT,data:t},r=[];t.segments.forEach((function(e){r.push(e.payload.buffer)})),e.postMessage(i,r)})),e.addEventListener("message",(function(e){var r=e.data;switch(r.cmd){case o.a.INIT:s.b.level(r.config.debug),function(e,i,r){(t=new a.a(e,i,r)).init()}(i,r.config,r.data);break;case o.a.DESTROY:t&&t.destroy(),i&&i.removeAllListeners();break;case o.a.APPEND_DATA:t.append(r.tags,r.timeOffset,r.isContinuous);break;case o.a.SET_CODECS:t.setCodecs(r.audioCodec,r.videoCodec);break;case o.a.FLV_HEAD:t.flvHead(r.hasAudio,r.hasVideo);break;case o.a.FLUSH:t.flush();break;case o.a.SET_EXTRA:t.setExtra(r.data);break;case o.a.LOAD_END:t.end()}}))}},function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return Ee}));var r=i(5),n=i(1);function o(){return(o=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)({}).hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(null,arguments)}var s={webWorker:!0,appendErrorMaxRetry:3,credentials:!1,defaultLiveDelay:-2e3,debug:n.a.LEVEL_ERROR,connectionTimeout:1e4,transmissionTimeout:3e4,autoRecoverMedia:!1,autoPlaybackRate:!0},a=function(){function e(){}return e.processConfig=function(e){var t=o({},s);return o(t,e),window.Worker||(t.webWorker=!1),t.debug&&n.b.level(t.debug),this._initPlayBackRateRule(t),t},e._initPlayBackRateRule=function(e){var t=e.autoPlaybackRateConf;if(t){var i=t.rule;if(i&&Array.isArray(i)&&((i=i.filter((function(e){return e.upper>e.lower&&e.rate>0}))).sort((function(e,t){return t.rate-e.rate})),i.length>1))return t.rule=i,void(e.autoPlaybackRateConf=t)}else{var r=-e.defaultLiveDelay/1e3,n={startDelay:r,interval:.2,rule:[{rate:1.1,lower:r+1,upper:Number.MAX_SAFE_INTEGER},{rate:1,lower:0,upper:r}]};e.autoPlaybackRateConf=n}},e}(),u=i(2),d=i(0),h=i(8),f=i.n(h);function _(e,t){if(void 0===t)return e;var i=e.split("?");i.splice(1,0,"?startPts="+t+(i.length>1?"&":""));var r=i.join("");return console.log("abrGetUrl:",r),r}var c=function(e){this.url=void 0,this.bitrate=0,this.maxBitrate=0,this.avgBitrate=0,this.qualityType="",this.qualityTypeName="",this.id=0,this.codec="",this.audioCodec="",this.videoCodec="",this.hidden=!1,this.disabledFromAdaptive=!1,this.defaultSelected=!1,this.url=e};function l(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,p(r.key),r)}}function p(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}var v,m=function(){function e(t){var i=this;this._levels=[],this._abrLevels=[],this._default=void 0,e.verify(t)&&(t.adaptationSet[0].representation.forEach((function(e,t){var r,n,o=new c(e.url);if(o.id=e.id||0,o.maxBitrate=e.maxBitrate||0,o.avgBitrate=e.avgBitrate||0,o.bitrate=e.avgBitrate||o.maxBitrate,o.qualityType=e.qualityType||"",o.qualityTypeName=e.qualityTypeName||"",o.codec=e.codec||"",o.codec){var s=(r=o.codec,n={},(r||"").split(/[ ,]+/).forEach((function(e){0===e.indexOf("avc1")&&(n.video=e),0===e.indexOf("mp4a")&&(n.audio=e)})),n);o.audioCodec=s.audio,o.videoCodec=s.video}o.hidden=e.hidden||!1,o.disabledFromAdaptive=e.disabledFromAdaptive||e.disabledFromAdaptive,o.defaultSelected=e.defaultSelected||!1,i._levels.push(o),o.disabledFromAdaptive||i._abrLevels.push(t),o.defaultSelected&&void 0===i._default&&(i._default=t)})),this._levels.sort((function(e,t){return e.bitrate-t.bitrate})))}return e.verify=function(e){return!!(e&&e.hasOwnProperty("version")&&e.hasOwnProperty("adaptationSet")&&Array.isArray(e.adaptationSet)&&e.adaptationSet.length>0)&&e.adaptationSet.reduce((function(e,t){return!!(e&&t.representation&&t.representation.length)}),!0)},t=e,(i=[{key:"levels",get:function(){return this._levels}},{key:"abrLevels",get:function(){return this._abrLevels}},{key:"default",get:function(){return this._default||0}}])&&l(t.prototype,i),r&&l(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,i,r}(),g=function(){function e(){this.tag="fetch",this._context=void 0,this._callbacks=null,this._controller=null,this._reader=null,this._abort=!1}e.isSupported=function(){return!(!self.fetch||!self.ReadableStream)};var t=e.prototype;return t.load=function(e,t){var i=this;this._context=e,this._callbacks=t;var r=new Headers;e.headers&&e.headers.forEach((function(e){r.append(e.header,e.value)}));var n={method:"GET",headers:r,mode:"cors",cache:"default",referrerPolicy:"no-referrer-when-downgrade",signal:this._getAbortSignal()};e.credentials&&(n.credentials="include"),fetch(e.url,n).then((function(t){if(e.responseUrl=t.url,e.responseHeader=t.headers,i._callbacks&&i._callbacks.onConnect&&i._callbacks.onConnect(t.status),t.ok)return i._abort?void(t.body&&t.body.getReader().cancel()):"arraybuffer"===e.responseType?e.progress?void(t.body&&(i._reader=t.body.getReader(),i._pump(i._reader))):void t.arrayBuffer().then((function(t){i._onEnd(e,t)})):void t.text().then((function(t){i._onEnd(e,t)}));var r=new Error(t.status+" "+t.statusText);i._onError(r)})).catch((function(e){"AbortError"!==e.name&&i._onError(e)}))},t.abort=function(){this._controller?this._controller.abort():this._reader&&(this._reader.cancel(),this._reader=null),this._abort=!0},t.destroy=function(){this._callbacks=null,this.abort()},t._onProgress=function(e,t){this._callbacks&&this._callbacks.onProgress&&this._callbacks.onProgress(t)},t._onEnd=function(e,t){this._callbacks&&this._callbacks.onEnd&&(this._reader=null,this._controller=null,this._callbacks.onEnd(t))},t._onError=function(e){this._callbacks&&this._callbacks.onError&&this._callbacks.onError(e)},t._pump=function(e){var t=this;e.read().then((function(i){if(t._abort)return e.cancel(),null;if(i.done)return t._onEnd(t._context,null),null;var r=i.value.buffer;return t._onProgress(t._context,r),t._pump(e)})).catch((function(e){"AbortError"!==e.name&&t._onError(e)}))},t._getAbortSignal=function(){try{if(AbortController)return this._controller=new AbortController,this._controller.signal}catch(e){return null}return null},e}(),y=function(e){return e.MOZ_CHUNK="moz-chunked-arraybuffer",e.MS_STREAM="ms-stream",e.UNKNOW="unknow",e.UNSUPPORT="",e}({}),b=function(){function e(){this.tag="xhr",this._xhr=null,this._context=void 0,this._callbacks=null,this._reader=null,this._msBufferOffset=0,this._msBufferUpper=16777216,this._progress=y.UNKNOW,this._xhr=null,this._msBufferOffset=0}e.isSupportedChunk=function(){if(e.supportChunk!==y.UNKNOW)return e.supportChunk;try{var t=new XMLHttpRequest;if(t.open("GET","https://example.com",!0),t.responseType=y.MOZ_CHUNK,t.responseType===y.MOZ_CHUNK)return e.supportChunk=y.MOZ_CHUNK,e.supportChunk}catch(t){e.supportChunk=y.UNSUPPORT}try{var i=new XMLHttpRequest;if(i.open("GET","https://example.com",!0),i.responseType=y.MS_STREAM,i.responseType===y.MS_STREAM)return e.supportChunk=y.MS_STREAM,e.supportChunk}catch(t){e.supportChunk=y.UNSUPPORT}return y.UNSUPPORT};var t=e.prototype;return t.load=function(t,i){if(this._callbacks=i,this._context=t,this._progress=y.UNSUPPORT,t.progress&&"arraybuffer"===t.responseType&&(this._progress=e.isSupportedChunk(),this._progress===y.MS_STREAM)){var r=this._reader=new self.MSStreamReader;r.onprogress=this._msrOnProgress.bind(this),r.onload=this._onLoadEnd.bind(this),r.onerror=this._onError.bind(this)}var n=this._xhr=new XMLHttpRequest;n.open("GET",this._context.url,!0),this._progress===y.MOZ_CHUNK?(n.responseType=y.MOZ_CHUNK,n.onprogress=this._onProgress.bind(this),n.onload=this._onLoadEnd.bind(this)):this._progress===y.MS_STREAM?n.responseType=y.MS_STREAM:(n.responseType=t.responseType||"arraybuffer",n.onload=this._onLoadEnd.bind(this)),n.onreadystatechange=this._onReadyStateChange.bind(this),n.onerror=this._onError.bind(this),n.withCredentials=!!t.credentials,n.send()},t.abort=function(){this._reader&&(1===this._reader.readyState&&this._reader.abort(),this._reader.onprogress=null,this._reader.onload=null,this._reader.onerror=null,this._reader=null),this._xhr&&(this._xhr.onreadystatechange=null,this._xhr.onprogress=null,this._xhr.onload=null,this._xhr.onerror=null,this._xhr.abort(),this._xhr=null)},t.destroy=function(){this._callbacks=null,this.abort()},t._onReadyStateChange=function(e){if(this._xhr){var t=this._xhr;2===t.readyState?(this._context.responseUrl=t.responseURL,this._context.responseHeader=t.getAllResponseHeaders(),this._callbacks&&this._callbacks.onConnect&&this._callbacks.onConnect(t.status),(t.status<200||t.status>299)&&this._onError(new Error("xhr error"))):3===t.readyState&&this._reader&&0===this._reader.readyState&&t.status>=200&&t.status<=299&&this._reader.readAsArrayBuffer(t.response)}},t._onProgress=function(e){if(this._xhr){var t=this._xhr.response;this._callbacks&&this._callbacks.onProgress&&t&&this._callbacks.onProgress(t)}},t._msrOnProgress=function(e){var t=e.target.result;if(t){var i=t.slice(this._msBufferOffset);this._msBufferOffset=t.byteLength,this._callbacks&&this._callbacks.onProgress&&this._callbacks.onProgress(i),t.byteLength>=this._msBufferUpper&&this._onError(new Error("ms buffer too large"))}else this._onError(new Error("ms buffer null"))},t._onLoadEnd=function(e){var t=null,i=this._xhr;!this._progress&&i&&(t=i.response),this._callbacks&&this._callbacks.onEnd(t)},t._onError=function(e){this._callbacks&&this._callbacks.onError&&this._callbacks.onError(e)},e}();function E(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,S(r.key),r)}}function S(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}b.supportChunk=y.UNKNOW;var R=function(){function e(){var e=this;this.tag="loader",this._context=void 0,this._loader=void 0,this._callbacks=void 0,this._config=void 0,this._loaderCallback=void 0,this._stats=void 0,this._retryDelay=0,this._loading=!1,this._aborted=!1,this._requestTimeout=void 0,this._transTimer=void 0,this._retryTimeout=void 0,this._progressTime=0,this._onConnect=function(t){e._requestTimeout&&(clearTimeout(e._requestTimeout),e._requestTimeout=null),e._startTransmissionTimer(),e._stats.httpStatusCode=t,e._stats.firstDataTime=Math.max(e._stats.requestStartTime,performance.now())},this._onProgress=function(t){var i=e._stats;e._progressTime=performance.now(),e._callbacks&&e._callbacks.onProgress&&e._callbacks.onProgress(e,t),i.loadedSize+=t.byteLength},this._onEnd=function(t){e._stopTimer();var i=e._stats;i.totalSize=t?i.loadedSize="string"==typeof t?t.length||0:t.byteLength||0:i.loadedSize,i.loadedTime=Math.max(i.firstDataTime,performance.now()),e._loading=!1,e._callbacks&&e._callbacks.onEnd(e,t)},this._onError=function(t){n.b.i(e.tag,t),e._stopTimer(),e._destroyInternalLoader();var i=e._stats,r=e._config;e._loading=!1,i.fatalError=!r.maxRetry||i.retryCount>=r.maxRetry||!r.maxRetry,i.errorMessage=t.message||"load error",e._callbacks&&e._callbacks.onError&&e._callbacks.onError(e),i.fatalError||(i.retryCount++,e._callbacks&&(e._retryDelay?(e._retryTimeout=setTimeout(e._loadInternal.bind(e),e._retryDelay),e._retryDelay=2*e._retryDelay):e._loadInternal()))},this._onTimeout=function(){e._loading=!1,e._abortInternal();var t=new Error("timeout");e._onError(t)},this._config={useFetch:!1,connectionTimeout:0,transmissionTimeout:0,maxRetry:0,retryDelay:0},this._loaderCallback={onConnect:this._onConnect,onProgress:this._onProgress,onEnd:this._onEnd,onError:this._onError}}var t,i,r,o=e.prototype;return o.load=function(e,t,i){this._context=e,this._callbacks=t,this._config=i||this._config,this._stats={requestStartTime:performance.now(),retryCount:0,loadedSize:0,httpStatusCode:0,firstDataTime:0,loadedTime:0,totalSize:0,errorMessage:"",fatalError:!1},this._config.retryDelay&&(this._retryDelay=this._config.retryDelay),this._loadInternal()},o.abort=function(){this._stopTimer(),this._abortInternal()},o.destroy=function(){this._stopTimer(),this._abortInternal(),this._destroyInternalLoader(),this._callbacks=void 0},o._getInternalLoader=function(e){return void 0!==v||(v=null,g.isSupported()?v=g:b.isSupportedChunk()&&(v=b)),v},o._destroyInternalLoader=function(){this._loader&&(this._loader.destroy(),this._loader=void 0)},o._loadInternal=function(){this._loading=!0,this._aborted=!1;var e=this._stats;e.httpStatusCode=0,e.firstDataTime=0,e.loadedSize=0,this._retryTimeout&&(clearTimeout(this._retryTimeout),this._retryTimeout=null),this._context.progress?this._loader=new(this._getInternalLoader(!!this._config.useFetch)):this._loader=new b,this._loader&&(this._config.connectionTimeout&&(this._requestTimeout=setTimeout(this._onTimeout,this._config.connectionTimeout)),this._loader.load(this._context,this._loaderCallback))},o._abortInternal=function(){this._callbacks&&this._callbacks.onAbort&&!this._aborted&&this._loading&&this._callbacks.onAbort(this),this._aborted=!0,this._loader&&this._loader.abort()},o._stopTimer=function(){this._requestTimeout&&(clearTimeout(this._requestTimeout),this._requestTimeout=null),this._retryTimeout&&(clearTimeout(this._retryTimeout),this._retryTimeout=null),this._stopTransmissionTimer()},o._startTransmissionTimer=function(){var e=this;this._stopTransmissionTimer(),this._progressTime=performance.now();var t=this._config.transmissionTimeout||0;t&&(this._transTimer=setInterval((function(){performance.now()-e._progressTime>t&&e._onTimeout()}),1e3))},o._stopTransmissionTimer=function(){this._transTimer&&(clearInterval(this._transTimer),this._transTimer=null)},t=e,(i=[{key:"stats",get:function(){return this._stats}},{key:"context",get:function(){return this._context}}])&&E(t.prototype,i),r&&E(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(),T=function(){function e(){var e=this;this._context=void 0,this._result=void 0,this._callback=void 0,this._loader=void 0,this._loaderConf=void 0,this._loaderCallbacks=void 0,this._timer=void 0,this._startTime=0,this._testEnd=function(){e._stopTimer(),e._loader&&e._loader.destroy(),e._context&&e._result&&e._callback&&(e._result.firstPackageDuration=Math.round(e._result.firstPackageDuration),e._result.duration=Math.round(performance.now()-e._startTime),e._callback.onEnd(e._context,e._result))},this._onProgress=function(t,i){e._result&&(e._result.firstPackageDuration=t.stats.firstDataTime?t.stats.firstDataTime-t.stats.requestStartTime:0,e._result.loaded=t.stats.loadedSize)},this._onLoaderError=function(){e._result&&(e._result.succeeded=!1),e._testEnd()},this._onLoaderEnd=function(){e._testEnd()},this._onAbort=function(){},this._loaderConf={connectionTimeout:0,transmissionTimeout:0,maxRetry:0,retryDelay:0,useFetch:!0},this._loaderCallbacks={onProgress:this._onProgress,onError:this._onLoaderError,onEnd:this._onLoaderEnd,onAbort:this._onAbort}}var t=e.prototype;return t.start=function(e,t){this._context=e,this._callback=t,this._result={loaded:0,duration:0,firstPackageDuration:0,succeeded:!0},this._startTime=performance.now(),this._loader&&this._loader.destroy();var i=Math.min(1e4,e.timeout);this._loaderConf.connectionTimeout=i;var r={url:e.url,progress:!0,responseType:"arraybuffer"};this._loader=new R,this._startTimer(i),this._loader.load(r,this._loaderCallbacks,this._loaderConf)},t.cancel=function(){this._stopTimer(),this._loader&&this._loader.destroy()},t.destroy=function(){this.cancel()},t._startTimer=function(e){var t=this;this._timer=setTimeout((function(){return t._testEnd()}),e)},t._stopTimer=function(){clearTimeout(this._timer)},e}();function L(){return(L=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)({}).hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(null,arguments)}function w(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,O(r.key),r)}}function O(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function M(e,t){return(M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var A={stableBufferDiffThresholdSecond:.15,stableBufferIntervalMs:2e3,speedTestTimeoutMs:500,generateSpeedGapMs:3e3,bufferCheckIntervalMs:500,smoothedSpeedUtilizationRatio:.8,smallSpeedToBitrateRatio:.4,enoughSpeedToBitrateRatio:.9,bufferLowerLimitSecond:.6,recentBufferedSize:16,smoothedSpeedRatio:.9,isSpeedFullyUsed:!0},k=function(e){function t(){var t;return(t=e.call(this)||this)._conf=void 0,t._pastBuffer=void 0,t._levels=void 0,t._current=0,t._next=0,t._stableBufferStartTime=performance.now(),t._speedTester=new T,t._generatedSpeed=0,t._lastCheckBuffer=0,t._lastSpeed=0,t._timer=void 0,t}var i,r;r=e,(i=t).prototype=Object.create(r.prototype),i.prototype.constructor=i,M(i,r);var o=t.prototype;return o.init=function(e,t,i){var r=this;this._conf=L({},A),L(this._conf,i),n.b.i("algorithm-simple","init",e,i,this._conf),this._levels=e.levels.slice(0),this._next=e.default,this._pastBuffer=[.1],t&&(this._timer=setInterval((function(){r._checkBuffer(t)}),this._conf.bufferCheckIntervalMs))},o._updateStableBuffer=function(e){var t=e-this._lastCheckBuffer,i=t/e,r=performance.now();return(t<-this._conf.stableBufferDiffThresholdSecond||i<-.2)&&(n.b.v("algorithm-simple","bufferDiffDown: "+t.toFixed(2)+"s, diffRatio: "+i.toFixed(2)),this._stableBufferStartTime=Math.max(r,this._stableBufferStartTime)),t>this._conf.stableBufferDiffThresholdSecond&&r-this._stableBufferStartTime+this._conf.bufferCheckIntervalMs>this._conf.stableBufferIntervalMs&&(this._stableBufferStartTime=Math.max(r-2*this._conf.bufferCheckIntervalMs,this._stableBufferStartTime+2*this._conf.bufferCheckIntervalMs),n.b.v("algorithm-simple","bufferDiffUp: "+t.toFixed(2)+"s")),this._lastCheckBuffer=e,r-this._stableBufferStartTime>this._conf.stableBufferIntervalMs},o._isSpeedFullyUsed=function(){return this._conf.isSpeedFullyUsed},o._checkBuffer=function(e){var t=e.bufferedSec(),i=this._updateStableBuffer(t);this._isSpeedFullyUsed()?i&&this._current+1<this._levels.length?this._generatedSpeed=this._levels[this._current+1].bitrate:this._generatedSpeed=0:i&&this._current+1<this._levels.length&&(this._startTesting(e),this._stableBufferStartTime=performance.now()+this._conf.generateSpeedGapMs),this._pastBuffer.push(t),this._pastBuffer.length>this._conf.recentBufferedSize&&this._pastBuffer.shift()},o._startTesting=function(e){var t=this;n.b.v("algorithm-simple","start speed testing on index: "+(this._current+1));var i=e.downloadSize(),r=this._levels[this._current+1].bitrate;this._speedTester.start({url:this._levels[this._current+1].url,timeout:this._conf.speedTestTimeoutMs},{onEnd:function(o,s){var a=e.downloadSize()-i;if(s.succeeded&&s.duration>0&&s.firstPackageDuration>0){var u=8*(a+s.loaded)/s.duration;n.b.v("algorithm-simple","testSpeed: "+u.toFixed(0)),u>=r&&(t._generatedSpeed=r)}n.b.v("algorithm-simple","succeeded: "+s.succeeded+", firstPackageDuration: "+s.firstPackageDuration+", originalDownloadSize: "+a+", downloadSize: "+s.loaded+", downloadTime: "+s.duration)}})},o.setAvailableBitrates=function(e){},o.onGOP=function(e,t,i){var r=t/Math.max(i,.05)*8/1024;n.b.v("algorithm-simple","buffered: "+e.toFixed(2)+", size: "+t+", time: "+i.toFixed(2)),this._next=this._nextRateIndex(r,e)},o.onLevelLoad=function(e){this._current=Math.max(0,e)},o.destroy=function(){this._speedTester.destroy(),clearInterval(this._timer)},o._quantization=function(e){for(var t=0,i=this._levels.length-1;i>=0;i--)if(e>=this._levels[i].bitrate){t=i;break}return t},o._nextRateIndex=function(e,t){var i=this._nextRateBySpeedAndBuffered(e,t);return i!=this._current&&(this._stableBufferStartTime=performance.now()+this._conf.generateSpeedGapMs),i<this._current?(this._speedTester.cancel(),this._generatedSpeed=0,this._lastSpeed=e,this._pastBuffer=[t]):this._lastSpeed=this._getSmoothedSpeed(e),i},o._getSmoothedSpeed=function(e){return this._lastSpeed>0?e*(1-this._conf.smoothedSpeedRatio)+this._lastSpeed*this._conf.smoothedSpeedRatio:e},o._getPredictedBuffer=function(e){return e+(e-Math.max.apply(Math,this._pastBuffer))},o._getBufferSpeed=function(e){var t=Math.max.apply(Math,this._pastBuffer);return(1+(e-t)/t)*this._levels[this._current].bitrate},o._isSpeedTooSmall=function(e){return e/this._levels[this._current].bitrate<this._conf.smallSpeedToBitrateRatio},o._isSpeedEnough=function(e){return e/this._levels[this._current].bitrate>this._conf.enoughSpeedToBitrateRatio},o._nextRateBySpeedAndBuffered=function(e,t){var i=this._getBufferSpeed(t),r=this._getSmoothedSpeed(e);n.b.v("algorithm-simple","gopSpeed: "+e.toFixed(0)+", smoothedSpeed: "+r.toFixed(0));var o=this._getPredictedBuffer(t);n.b.v("algorithm-simple","bufferSpeed: "+i.toFixed(0)+", predictedBuffered: "+o.toFixed(1));var s=this._current;return o<this._conf.bufferLowerLimitSecond||this._isSpeedTooSmall(i)?s=Math.min(this._current,this._quantization(i)):this._isSpeedEnough(i)&&(this._generatedSpeed>0?(n.b.i("algorithm-simple","generatedSpeed used"),s=this._quantization(this._generatedSpeed),this._generatedSpeed=0):s=this._quantization(r*this._conf.smoothedSpeedUtilizationRatio),s=Math.min(this._current+1,Math.max(s,this._current))),s},function(e,t,i){return t&&w(e.prototype,t),i&&w(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}(t,[{key:"nextLevel",get:function(){return n.b.v("algorithm-simple","nextLevel: "+this._next),this._next}}])}(r.EventEmitter);function x(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,D(r.key),r)}}function D(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}var C=function(){function e(e,t,i,r){var n=this;this._eventEmitter=void 0,this._config=void 0,this._media=void 0,this._next=0,this._downloadSizeTotal=0,this._downloadSize=0,this._downloadStartTime=0,this._keyCount=0,this._index=0,this._alg=void 0,this._manifest=void 0,this._autoLevelEnabled=!1,this._eventEmitter=e,this._config=t,this._media=i,this._manifest=new m(r);var o={bufferedSec:function(){return n._media.bufferedSec()},downloadSize:function(){return n._downloadSizeTotal}};this._alg=new k,this._alg.init(this._manifest,o),this._autoLevelEnabled=this._manifest.abrLevels.length>0}var t,i,r,n=e.prototype;return n.init=function(){this._downloadSizeTotal=0,this._downloadSize=0,this._downloadStartTime=performance.now(),this._keyCount=0,this._index=this._next=0,this.current&&(this._autoLevelEnabled&&(this._index=this._next=this._alg.nextLevel),this._eventEmitter.emit(d.a.MANIFEST_PARSED,{levels:this._manifest.levels,currentLevel:this._index}))},n.destory=function(){this._alg&&(this._alg.destroy(),this._alg.removeAllListeners())},n.onLoaderChunk=function(e){this._downloadSize+=e,this._downloadSizeTotal+=e},n.onLevelLoad=function(e){this._manifest.levels.length&&e>=0&&e<this._manifest.levels.length&&(this._keyCount=0,this._index=e,this._downloadStartTime=performance.now(),this._downloadSize=0,this._alg.onLevelLoad(e))},n.onKeyFrame=function(e){var t=this._manifest.levels;if(this._keyCount++,(this._alg||this._next!==this._index)&&this._keyCount>1&&t){var i=this._index;if(this._next!==this._index)i=this._next;else{if(!this._autoLevelEnabled)return;var r=performance.now();this._alg.onGOP(this._media.bufferedSec(),this._downloadSize,(r-this._downloadStartTime)/1e3),this._downloadSize=0,this._downloadStartTime=r,this._next=i=this._alg.nextLevel}if(i!==this._index)return{url:this._getRequestUrl(i,e),level:i,timestamp:e}}},n._getRequestUrl=function(e,t){var i="",r=this._manifest.levels[e];return r&&(i=r.url),_(i,t||this._config.defaultLiveDelay)},t=e,(i=[{key:"autoLevelEnabled",get:function(){return this._autoLevelEnabled}},{key:"levels",get:function(){return this._manifest.levels}},{key:"nextLevel",get:function(){return"number"==typeof this._next?this._next:this._index},set:function(e){e>=0&&this._manifest.levels.length>e?(this._autoLevelEnabled=!1,this._next=e):-1===e&&(this._autoLevelEnabled=!0)}},{key:"currentLevel",get:function(){return this._index},set:function(e){e>=0&&this._manifest.levels.length>e?(this._autoLevelEnabled=!1,this._index=this._next=e):-1===e&&(this._autoLevelEnabled=!0)}},{key:"current",get:function(){return this._manifest.levels[this._index]}}])&&x(t.prototype,i),r&&x(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}(),P=i(7);function I(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,B(r.key),r)}}function B(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}var N=function(){function e(t){void 0===t&&(t=0),this._size=void 0,this._readOffset=0,this._writeOffset=0,this._storage=void 0,this._cache=void 0,this._size=t>0?t:e.DEFAULT_CACHE_SIZE,this._storage=new ArrayBuffer(this._size),this._cache=new Uint8Array(this._storage)}var t,i,r,n=e.prototype;return n.put=function(e){if(this._readOffset===this._writeOffset&&(this._readOffset=this._writeOffset=0),this._writeOffset+e.byteLength>this._size){var t=this._writeOffset+e.byteLength-this._readOffset;t>this._size?(this._collateCache(),this.expandCache(t)):this._collateCache()}this._cache.set(e,this._writeOffset),this._writeOffset+=e.byteLength},n.get=function(e){if(e+this._readOffset>this._writeOffset)return null;var t=null;if(this._cache.slice)t=this._cache.slice(this._readOffset,this._readOffset+e);else{var i=this._cache.byteOffset+this._readOffset;t=new Uint8Array(this._storage.slice(i,i+e))}return this._readOffset+=e,t},n.read=function(e){return e+this._readOffset>this._writeOffset?null:new Uint8Array(this._storage,this._readOffset,e)},n.skip=function(e){e+this._readOffset>this._writeOffset||(this._readOffset+=e)},n.clear=function(){this._readOffset=this._writeOffset=0},n.expandCache=function(t){if(void 0===t&&(t=0),this._size=Math.max(2*this._size,t),this._size>=e.MAX_CACHE_SIZE)throw new Error("max cache size");0===this._readOffset&&0===this._writeOffset?this._storage=new ArrayBuffer(this._size):this._storage=this._transfer(this._storage,this._size),this._cache=new Uint8Array(this._storage)},n._collateCache=function(){var e=new Uint8Array(this._storage,this._readOffset,this._writeOffset-this._readOffset);this._cache.set(e),this._writeOffset-=this._readOffset,this._readOffset=0},n._transfer=function(e,t){if(!(e instanceof ArrayBuffer))throw new TypeError("Source must be an instance of ArrayBuffer");if(t<=e.byteLength)return e.slice(0,t);var i=new Uint8Array(e),r=new Uint8Array(new ArrayBuffer(t));return r.set(i),r.buffer},t=e,(i=[{key:"unreadLen",get:function(){return this._writeOffset-this._readOffset}}])&&I(t.prototype,i),r&&I(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}();N.MAX_CACHE_SIZE=104857600,N.DEFAULT_CACHE_SIZE=3145728;var F=N,U=i(3),V=function(){function e(e,t){this._eventEmitter=void 0,this._cache=void 0,this._tag=void 0,this._result=void 0,this._parseLen=0,this._parseFunc=void 0,this._onFlvKeyframe=void 0,this._eventEmitter=e,this._onFlvKeyframe=t,this._cache=new F,this._parseLen=U.a.FLV_HEAD_LEN,this._parseFunc=this._parseFlvHead,this._result={list:[]}}var t=e.prototype;return t.reset=function(){this._parseLen=U.a.FLV_HEAD_LEN,this._parseFunc=this._parseFlvHead,this._cache.clear(),this._tag=void 0,this._result.list=[],this._result.callbackResult=void 0},t.processing=function(e){for(this._cache.put(new Uint8Array(e));this._cache.unreadLen>this._parseLen;)this._parseFunc();var t={list:this._result.list.splice(0),callbackResult:this._result.callbackResult};return this._result.callbackResult=void 0,t},t._parseFlvHead=function(){var e=this._cache.read(U.a.FLV_HEAD_LEN);e&&(70===e[0]&&76===e[1]&&86===e[2]&&1===e[3]||this._eventEmitter.emit(d.a.ERROR,{type:u.b.MUX_ERROR,details:u.a.DEMUX_ERROR,fatal:!0,info:{reason:"flv wrong head"}}),this._eventEmitter.emit(d.a.FLV_HEAD,{hasAudio:(4&e[4])>>>2,hasVideo:1&e[4]}),this._cache.skip(U.a.FLV_HEAD_LEN),this._parseLen=U.a.FLV_TAG_HEAD_LEN,this._parseFunc=this._parseFlvTagHead)},t._parseFlvTagHead=function(){this._tag=new U.b;var e=this._cache.read(U.a.FLV_TAG_HEAD_LEN);e&&(this._tag.tagType=e[0],this._tag.dataSize=((255&e[1])<<16)+((255&e[2])<<8)+(255&e[3]),this._tag.timestamp=((255&e[7])<<24)+((255&e[4])<<16)+((255&e[5])<<8)+(255&e[6]),this._cache.skip(U.a.FLV_TAG_HEAD_LEN),this._tag.tagType===U.c.VIDEO?(this._parseFunc=this._detectKeyFrame,this._parseLen=U.a.AVC_KEY_FRAME_CHECK_LEN):(this._parseFunc=this._parseFlvTag,this._parseLen=this._tag.dataSize+U.a.FLV_TAG_SIZE_LEN))},t._detectKeyFrame=function(){var e=this._cache.read(2);if(e&&this._tag){var t=(240&e[0])>>>4,i=e[1];this._parseFunc=this._parseFlvTag,this._parseLen=this._tag.dataSize+U.a.FLV_TAG_SIZE_LEN,1===t&&1===i&&this._onFlvKeyframe&&(this._result.callbackResult=this._onFlvKeyframe(this._tag.timestamp),this._result.callbackResult&&(this._parseLen=U.a.FLV_HEAD_LEN,this._parseFunc=this._parseFlvHead,this._cache.clear(),this._tag=void 0))}},t._parseFlvTag=function(){var e=this._tag;e&&(e.tagType!==U.c.SCRIPT&&e.tagType!==U.c.AUDIO&&e.tagType!==U.c.VIDEO||(e.body=this._cache.get(e.dataSize),this._cache.skip(4),e&&this._result.list.push(e),this._tag=void 0),this._parseFunc=this._parseFlvTagHead,this._parseLen=U.a.FLV_TAG_HEAD_LEN)},e}(),j="startLoadStream",H="loader-chunk-arrival",q="keyFrame",z=i(4);function W(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,G(r.key),r)}}function G(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function Q(e,t){return(Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var K=new RegExp("^(http|https)://"),X=function(e){function t(t,i){var o;(o=e.call(this)||this)._config=void 0,o._media=void 0,o._w=void 0,o._flv=void 0,o._eventEmitter=void 0,o._loader=void 0,o._loaderConf=void 0,o._loaderCallbacks=void 0,o._multirate=void 0,o._isContinuous=void 0,o._remuxId=void 0,o._baseTimeSec=0,o._tagDump=void 0,o._currentUrl=void 0,o._isAbr=!1,o._progressTime=0,o._src=void 0,o._audioCodec="",o._onWorkerEvent=function(e){var t=e.data;o._onEvent(t.event,t.data)},o._flvKeyframeCallback=function(e){return o._media.hasStreamTime||o._media.updateStreamTime(e/1e3,0),o._multirate?o._multirate.onKeyFrame(e):void 0},o._onEvent=function(e,t){switch(e){case d.a.FLV_HEAD:o._w?o._w.postMessage({cmd:z.a.FLV_HEAD,hasAudio:t.hasAudio,hasVideo:t.hasVideo}):o._flv&&o._flv.flvHead(t.hasAudio,t.hasVideo);break;case d.a.MEDIA_INFO:o.emit(d.a.MEDIA_INFO,t);break;case d.a.MP4_SEGMENT:var i=t;if(i.extra&&i.extra.remuxId!==o._remuxId)break;i.segments.forEach((function(e){"audio"===e.type&&e.startDTS>o._baseTimeSec&&o._media.updateStreamTime(e.streamDTS,e.startDTS)})),o.emit(d.a.MP4_SEGMENT,i);break;default:o.emit(e,t)}},o._onLoaderProgress=function(e,t){if(t instanceof ArrayBuffer){o._multirate&&o._multirate.onLoaderChunk(t.byteLength),o.emit(d.a.REPORT,{type:H,byteLength:t.byteLength,timeCost:performance.now()-o._progressTime||e.stats.requestStartTime,header:e.context.responseHeader}),o._progressTime=performance.now();var i=o._tagDump.processing(t);o._append(i.list,o._baseTimeSec,o._isContinuous),o._isContinuous=!0,i.callbackResult&&(o._tagDump&&o._tagDump.reset(),o._baseTimeSec=i.callbackResult.timestamp&&o._media.getLocalTime(i.callbackResult.timestamp/1e3)||0,o.emit(d.a.LEVEL_SWITCHING,{level:i.callbackResult.level,startSec:o._baseTimeSec,smooth:!0}),o._load(i.callbackResult.url,i.callbackResult.level))}},o._onLoaderAbort=function(){},o._onLoaderError=function(e){if(e.stats.fatalError){var t={type:u.b.NETWORK_ERROR,details:"timeout"===e.stats.errorMessage?u.a.LOAD_ERROR_TIMEOUT:u.a.LOAD_ERROR,fatal:!0,info:{url:e.context.url,httpStatusCode:e.stats.httpStatusCode,reason:e.stats.errorMessage}};o.emit(d.a.ERROR,t)}},o._onLoaderEnd=function(){o._w?o._w.postMessage({cmd:z.a.LOAD_END}):o._flv&&o._flv.end()},o._config=t,o._media=i,o._loaderConf={connectionTimeout:o._config.connectionTimeout,transmissionTimeout:o._config.transmissionTimeout,maxRetry:0,retryDelay:0,useFetch:!0},o._loaderCallbacks={onProgress:o._onLoaderProgress,onError:o._onLoaderError,onEnd:o._onLoaderEnd,onAbort:o._onLoaderAbort},o._isContinuous=!1,o._remuxId=1;var s=o._eventEmitter=new r.EventEmitter;return s.on(d.a.MEDIA_INFO,(function(e){o._onEvent(d.a.MEDIA_INFO,e)})),s.on(d.a.SCRIPT_PARSED,(function(e){o._onEvent(d.a.SCRIPT_PARSED,e)})),s.on(d.a.MANIFEST_PARSED,(function(e){o._onEvent(d.a.MANIFEST_PARSED,e)})),s.on(d.a.MP4_SEGMENT,(function(e){o._onEvent(d.a.MP4_SEGMENT,e)})),s.on(d.a.ERROR,(function(e){o._onEvent(d.a.ERROR,e)})),s.on(d.a.FLV_HEAD,(function(e){o._onEvent(d.a.FLV_HEAD,e)})),o._tagDump=new V(o._eventEmitter,o._flvKeyframeCallback),o._config.webWorker&&(n.b.i("LasMain","webWorker"),o._w=f()(9),o._w)?(o._w.addEventListener("message",o._onWorkerEvent),o._w.postMessage({cmd:z.a.INIT,config:o._config,data:{remuxId:o._remuxId}}),function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(o)):(o._flv=new P.a(s,o._config,{remuxId:o._remuxId}),o._flv.init(),o)}var i,o;o=e,(i=t).prototype=Object.create(o.prototype),i.prototype.constructor=i,Q(i,o);var s=t.prototype;return s.init=function(e,t){if(void 0===t&&(t=""),this._src=e,this._audioCodec=t,"string"==typeof e&&!K.test(e))try{this._src=JSON.parse(e)}catch(e){return void this.emit(d.a.ERROR,{type:u.b.OTHER_ERROR,details:u.a.MANIFEST_ERROR,fatal:!0,info:{reason:"manifest parse error"}})}this._src?(m.verify(this._src)&&(this._isAbr=!0),this._isAbr&&!this._multirate&&(this._multirate=new C(this._eventEmitter,this._config,this._media,this._src),this._multirate.init())):this.emit(d.a.ERROR,{type:u.b.OTHER_ERROR,details:u.a.MANIFEST_ERROR,fatal:!0,info:{reason:"src empty"}})},s.load=function(){var e=this._multirate;if(e){var t=e.levels[e.currentLevel];t?this._load(_(t.url,this._config.defaultLiveDelay),e.currentLevel):this.emit(d.a.ERROR,{type:u.b.OTHER_ERROR,details:u.a.MANIFEST_ERROR,fatal:!0,info:{reason:"manifest parse error"}})}else this._load(this._src)},s.destroy=function(){this._destroyLoader(),this._w&&(this._w.postMessage({cmd:z.a.DESTROY}),this._w.removeEventListener("message",this._onWorkerEvent),this._w.terminate()),this._flv&&(this._flv.destroy(),this._flv=void 0),this._multirate&&this._multirate.destory();var e=this._eventEmitter;e&&e.removeAllListeners()},s._destroyLoader=function(){this._loader&&(this._loader.destroy(),this._loader=void 0)},s._load=function(e,t){void 0===t&&(t=0),this._destroyLoader(),this._multirate&&this._multirate.onLevelLoad(t),this._currentUrl=e;var i=this.levels[t];i&&this._updateCodecs(this._audioCodec||i.audioCodec,i.videoCodec),this.emit(d.a.REPORT,{type:j,url:e,sync:this._baseTimeSec,index:t,bitrate:i?i.bitrate:0}),this._loader||(this._loader=new R);var r={url:e,progress:!0,responseType:"arraybuffer",credentials:this._config.credentials};this._loader instanceof R&&this._loader.load(r,this._loaderCallbacks,this._loaderConf)},s._append=function(e,t,i){this._w?this._w.postMessage({cmd:z.a.APPEND_DATA,tags:e,timeOffset:t||0,isContinuous:i}):this._flv&&this._flv.append(e,t||0,i)},s._updateCodecs=function(e,t){void 0===e&&(e=""),void 0===t&&(t=""),this._w?this._w.postMessage({cmd:z.a.SET_CODECS,audioCodec:e,videoCodec:t}):this._flv&&this._flv.setCodecs(e,t)},s._refreshRemuxId=function(){this._remuxId++;var e={remuxId:this._remuxId};this._w?this._w.postMessage({cmd:z.a.SET_EXTRA,data:e}):this._flv&&this._flv.setExtra(e)},function(e,t,i){return t&&W(e.prototype,t),i&&W(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}(t,[{key:"autoLevelEnabled",get:function(){return!!this._multirate&&this._multirate.autoLevelEnabled}},{key:"levels",get:function(){return this._multirate?this._multirate.levels:[]}},{key:"nextLevel",get:function(){return this._multirate?this._multirate.nextLevel:0},set:function(e){var t=this._multirate;t&&(t.nextLevel=e)}},{key:"currentLevel",get:function(){return this._multirate?this._multirate.currentLevel:0},set:function(e){var t=this._multirate;if(t){var i=e>=0||e!==t.currentLevel;t.currentLevel=e;var r=t.levels[t.currentLevel];i&&r&&(this._currentUrl=_(r.url,this._config.defaultLiveDelay),this._refreshRemuxId(),this._isContinuous=!1,this._tagDump&&this._tagDump.reset(),this._baseTimeSec=this._media.currentTime,this.emit(d.a.LEVEL_SWITCHING,{level:t.currentLevel,startSec:this._baseTimeSec,smooth:!1}),this._load(this._currentUrl,t.currentLevel))}}}])}(r.EventEmitter);function Z(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,Y(r.key),r)}}function Y(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}var J=function(){function e(){this._video=void 0,this._mse=void 0,this._streamTime=0,this._localTime=0}var t,i,r,n=e.prototype;return n.reset=function(){this._streamTime=0,this._localTime=0},n.attachVideo=function(e){this._video=e},n.attachMSE=function(e){this._mse=e},n.isTimeinBuffered=function(e){if(this._video)for(var t=this._video.buffered,i=0;i<t.length;i++)if(e>=t.start(i)&&e<t.end(i))return!0;return!1},n.bufferedSec=function(){return this._video&&this._video.buffered.length>0?Math.max(0,this._video.buffered.end(this._video.buffered.length-1)-this._video.currentTime):0},n.bufferedSecByType=function(e){if(this._mse&&this._video&&this._mse.bufferedEndByType(e)>0)return this._mse.bufferedEndByType(e)-this._video.currentTime;return 0},n.mseBufferedSecByType=function(e){return this._mse?this._mse.bufferedByType(e):{start:0,end:0}},n.bufferSliceNumByType=function(e){return this._mse?this._mse.bufferSliceNumByType(e):0},n.pendingNum=function(){return this._mse?this._mse.pendingNum():0},n.pendingSecByType=function(e){return this._mse?this._mse.pendingSecByType(e):0},n.currentBuffer=function(e){if(this._video)for(var t=this._video.buffered,i=0;i<t.length;i++){var r=t.start(i),n=t.end(i);if(r<=e&&e<n)return{start:r,end:n}}},n.nextBuffer=function(e){if(this._video)for(var t=this._video.buffered,i=0;i<t.length;i++){var r=t.start(i),n=t.end(i);if(r>e)return{start:r,end:n}}},n.updateStreamTime=function(e,t){this._streamTime=e,this._localTime=t},n.getLocalTime=function(e){if(this._streamTime)return e-this._streamTime+this._localTime},t=e,(i=[{key:"hasStreamTime",get:function(){return!!this._streamTime}},{key:"video",get:function(){return this._video}},{key:"mse",get:function(){return this._mse}},{key:"mseReadyState",get:function(){return this._mse?this._mse.readyState:"closed"}},{key:"videoReadyState",get:function(){return this._video?this._video.readyState:0}},{key:"currentTime",get:function(){return this._video?this._video.currentTime:0}}])&&Z(t.prototype,i),r&&Z(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}();function $(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ee(r.key),r)}}function ee(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function te(e,t){return(te=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var ie=function(e){function t(t){var i;return(i=e.call(this)||this).tag="MSE",i._config=void 0,i.video=void 0,i._sourceBuffer=void 0,i._mediaSource=null,i._mimeCodec=void 0,i._cleanUpTask=void 0,i._appendQueue=void 0,i._hasVideo=void 0,i._hasAudio=void 0,i._endOfData=!1,i._appendEnabled=void 0,i._duration=null,i._appendError=0,i._appendBufferError=!1,i._sbHandler={},i._onSourceOpen=function(){n.b.i(i.tag,"MediaSource onSourceOpen"),i._mediaSource&&(i._mediaSource.removeEventListener("sourceopen",i._onSourceOpen),i._checkSourceBuffer(),i.refresh(),i.emit("source_open"))},i._onSourceEnded=function(){n.b.i(i.tag,"MediaSource onSourceEnded")},i._onSourceClose=function(){n.b.i(i.tag,"MediaSource onSourceClose"),i._mediaSource&&(i._mediaSource.removeEventListener("sourceopen",i._onSourceOpen),i._mediaSource.removeEventListener("sourceended",i._onSourceEnded),i._mediaSource.removeEventListener("sourceclose",i._onSourceClose))},i._onSourceBufferUpdateEnd=function(e){i._update(e),i._endOfData&&i._endOfStream(),i.emit("updateend")},i._onSourceBufferError=function(e){n.b.e(i.tag,"SourceBuffer Error: "+e),i.emit(d.a.ERROR,{type:u.b.MSE_ERROR,details:u.a.SOURCEBUFFER_ERROR,fatal:!0,info:{reason:"source buffer error"}})},i._config=t,i._hasVideo=!1,i._hasAudio=!1,i._appendQueue={video:[],audio:[],audiovideo:[]},i._sourceBuffer={},i._cleanUpTask={video:[],audio:[],audiovideo:[]},i._mimeCodec={},i._appendEnabled=!0,i}var i,r;r=e,(i=t).prototype=Object.create(r.prototype),i.prototype.constructor=i,te(i,r);var o=t.prototype;return o.attach=function(e){var t=this;this.video=e;var i=window.MediaSource||window.WebKitMediaSource;if(i){var r=this._mediaSource=new i;this.video.src=URL.createObjectURL(r),this.video.load(),r.addEventListener("sourceopen",this._onSourceOpen),r.addEventListener("sourceended",this._onSourceEnded),r.addEventListener("sourceclose",this._onSourceClose)}else setTimeout((function(){t.emit(d.a.ERROR,{type:u.b.MSE_ERROR,details:u.a.MEDIASOURCE_ERROR,fatal:!0,info:{reason:"MediaSource is not support"}})}),0)},o.mediaInit=function(e){if((this._hasAudio!==e.hasAudio||this._hasVideo!==e.hasVideo||!!e.audiovideo!=!!this._mimeCodec.audiovideo)&&this.video&&this.hasSourceBuffer()){for(var t in n.b.i(this.tag,"trackInfo rebuild mse"),this._sourceBuffer)this._sourceBuffer[t]&&this._sbHandler[t]&&(this._sourceBuffer[t].removeEventListener("error",this._sbHandler[t].error),this._sourceBuffer[t].removeEventListener("updateend",this._sbHandler[t].updateend));this._sourceBuffer={},this._mediaSource&&(this._mediaSource.removeEventListener("sourceopen",this._onSourceOpen),this._mediaSource.removeEventListener("sourceended",this._onSourceEnded),this._mediaSource.removeEventListener("sourceclose",this._onSourceClose)),this._mimeCodec={},this.attach(this.video)}e.audiovideo?this._mimeCodec.audiovideo='video/mp4; codecs="'+e.codec+'"':(e.hasAudio&&e.audioCodec&&(this._mimeCodec.audio='audio/mp4; codecs="'+e.audioCodec+'"'),e.hasVideo&&e.videoCodec&&(this._mimeCodec.video='video/mp4; codecs="'+e.videoCodec+'"')),this._hasAudio=this._hasAudio||e.hasAudio,this._hasVideo=this._hasVideo||e.hasVideo,this._checkSourceBuffer()},o.refresh=function(){for(var e in this._sourceBuffer)this._update(e)},o.mediaSegment=function(e){var t=this;e.forEach((function(e){var i=e.type;t._appendQueue[i].push(e),t._sourceBuffer[i]&&t._update(i)}))},o.bufferedByType=function(e){var t=this._sourceBuffer[e];return t&&t.buffered.length>0?{start:t.buffered.start(0),end:t.buffered.end(t.buffered.length-1)}:{start:0,end:0}},o.bufferedEndByType=function(e){var t=this._sourceBuffer[e];return t&&t.buffered.length>0?t.buffered.end(t.buffered.length-1):0},o.bufferSliceNumByType=function(e){var t=this._sourceBuffer[e];return t?t.buffered.length:0},o.pendingSecByType=function(e){var t=this._appendQueue[e];return t?t.reduce((function(e,t){return e+t.endDTS-t.startDTS}),0):0},o.pendingNum=function(){var e=0;for(var t in this._appendQueue)e+=this._appendQueue[t].length;return e},o._checkSourceBuffer=function(){var e=(this._hasAudio?1:0)+(this._hasVideo?1:0),t=(this._mimeCodec.audio?1:0)+(this._mimeCodec.video?1:0);if(this._mimeCodec.audiovideo&&(e=1,t=1),n.b.v(this.tag,"checkSourceBuffer",e,t,this._mimeCodec),this._mediaSource&&"open"===this._mediaSource.readyState&&e>0&&t>=e)for(var i in this._mimeCodec)this._mimeCodec[i]&&this._addSourceBuffer(i)},o._addSourceBuffer=function(e){var t=this;if(!this._sourceBuffer[e]){try{this._mediaSource&&(this._sourceBuffer[e]=this._mediaSource.addSourceBuffer(this._mimeCodec[e]))}catch(e){return n.b.e(this.tag,e),void this.emit(d.a.ERROR,{type:u.b.MSE_ERROR,details:u.a.ADDSOURCEBUFFER_ERROR,fatal:!0,info:{reason:e.message}})}var i=this._sourceBuffer[e];this._sbHandler[e]={updateend:function(){t._onSourceBufferUpdateEnd(e)},error:function(e){t._onSourceBufferError(e)}},i.addEventListener("error",this._sbHandler[e].error),i.addEventListener("updateend",this._sbHandler[e].updateend),this._duration&&this._mediaSource&&(this._mediaSource.duration=this._duration)}},o._hasPendingData=function(){return!(!this._appendQueue||!(this._appendQueue.video&&this._appendQueue.video.length||this._appendQueue.audio&&this._appendQueue.audio.length))},o._doAppend=function(e){if(this._hasPendingData()){if(!this._appendEnabled)return void(this._getBufferQueueSize()>209715200&&!this._appendBufferError&&(this._appendBufferError=!0,this.emit(d.a.ERROR,{type:u.b.MSE_ERROR,details:u.a.APPENDBUFFER_ERROR,fatal:!0,info:{reason:"bufferfull"}})));if(this._appendQueue[e].length>0&&this._sourceBuffer[e]&&!this._sourceBuffer[e].updating&&!this._appendBufferError){var t=this._appendQueue[e].shift();this._appendBuffer(t)}}},o._calculateRemoveRange=function(e){var t=this.video;if(t&&!t.seeking){var i=t.currentTime;if(this._sourceBuffer[e]){var r=this._cleanUpTask[e],n=this._sourceBuffer[e].buffered;if(n.length>=1&&i-n.start(0)>=10){var o=i-5;if(r.length&&0===r[r.length-1].start&&r[r.length-1].end===o)return;r.push({start:0,end:o})}}}},o._cleanUpRange=function(e,t){var i=this._sourceBuffer[e];if(i){if(i.updating)return!1;try{for(var r=0;r<i.buffered.length;r++){var n=i.buffered.end(r),o=Math.max(0,t.start),s=Math.min(n,t.end);if(s>o&&(i.remove(o,s),this.emit("remove"),r<i.buffered.length-1))return!1}}catch(e){}}return!0},o._appendBuffer=function(e){if(e&&this._sourceBuffer[e.type]&&this.video&&!this.video.error)try{this._sourceBuffer[e.type].appendBuffer(e.payload.buffer)}catch(o){if(n.b.w(this.tag,o.code,o),22!==o.code)this._appendError?this._appendError++:this._appendError=1,this._appendError>this._config.appendErrorMaxRetry?(this._appendBufferError=!0,this.emit(d.a.ERROR,{type:u.b.MSE_ERROR,details:u.a.APPENDBUFFER_ERROR,fatal:!0,info:{reason:o.message}})):this._appendQueue[e.type].unshift(e);else{var t=this.video;this._config;this._appendEnabled=!1,this._appendQueue[e.type].unshift(e);var i=t.buffered.end(t.buffered.length-1)-t.currentTime,r=t.currentTime-t.buffered.start(0);i<30?(this._calculateRemoveRange(e.type),this.hasCleanUpTask(e.type)&&this._cleanUp(e.type)):r<10&&this.emit(d.a.ERROR,{type:u.b.MSE_ERROR,details:u.a.APPENDBUFFER_ERROR,fatal:!0,info:{reason:"buffer full, append error"}}),n.b.i(this.tag,"mse bufferfull"),this.emit("bufferFull")}}},o.flush=function(e,t,i){var r=0,n=Number.POSITIVE_INFINITY;for(var o in this._endOfData=!1,this._sourceBuffer){if(!i||i===o)if(this._sourceBuffer[o]){if(e){r=Math.max(r,e);for(var s=this._appendQueue[o].length-1;s>=0&&(!this._appendQueue[o][s].startPTS||this._appendQueue[o][s].startPTS>=e);s--)this._appendQueue[o].pop()}else this._appendQueue[o]=[];t&&(n=Math.min(n,t)),this._cleanUpTask[o].push({start:r,end:n}),this._cleanUp(o)}}this._appendEnabled=!0},o.setAppendEnabled=function(e){!this._appendEnabled&&e?(this._appendEnabled=e,this.refresh()):this._appendEnabled=e},o.getAppendEnabled=function(){return this._appendEnabled},o.endOfData=function(){this._endOfData=!0,this._hasPendingData()||this._endOfStream()},o.ended=function(){return this._endOfData},o._endOfStream=function(){var e=this._mediaSource;if(e&&"open"===e.readyState){for(var t in this._sourceBuffer){var i=this._sourceBuffer[t];if(i&&i.updating)return}try{e.endOfStream()}catch(e){n.b.e(this.tag,e),this.emit(d.a.ERROR,{type:u.b.MSE_ERROR,details:u.a.ENDOFSTREAM_ERROR,fatal:!0,info:{reason:e.message}})}}},o.destroy=function(){if(this._mediaSource){var e=this._mediaSource;if(this._endOfStream(),"closed"!==e.readyState)for(var t in this._sourceBuffer)this._sourceBuffer[t]&&this._sbHandler[t]&&(this._sourceBuffer[t].removeEventListener("error",this._sbHandler[t].error),this._sourceBuffer[t].removeEventListener("updateend",this._sbHandler[t].updateend),e.removeSourceBuffer(this._sourceBuffer[t]));e.removeEventListener("sourceopen",this._onSourceOpen),e.removeEventListener("sourceended",this._onSourceEnded),e.removeEventListener("sourceclose",this._onSourceClose),this._mediaSource=null}this.removeAllListeners(),this._appendQueue={},this._mimeCodec={},this._cleanUpTask={},this._sourceBuffer={},this._sbHandler={}},o.hasCleanUpTask=function(e){var t=0;if(void 0===e)for(var i in this._cleanUpTask)t+=this._cleanUpTask[i].length;else this._cleanUpTask[e]&&(t=this._cleanUpTask[e].length);return t>0},o.hasSourceBuffer=function(){return!!Object.keys(this._sourceBuffer).length},o._getBufferQueueSize=function(){var e=0;for(var t in this._appendQueue)e+=this._appendQueue[t].reduce((function(e,t){return t.payload&&t.payload.byteLength?e+t.payload.byteLength:e}),0);return e},o.getBufferQueueSec=function(e){var t=this;return this._appendQueue?(e?[e]:Object.keys(this._appendQueue)).reduce((function(e,i){return t._appendQueue[i]&&t._appendQueue[i].length>0&&(0===Object.keys(t._sourceBuffer).length||t._sourceBuffer[i])?Math.max(e,t._appendQueue[i].reduce((function(e,t){var i=t.endDTS-t.startDTS;return i?e+i:e}),0)):e}),0):0},o._update=function(e){this.hasCleanUpTask(e)&&this._cleanUp(e),this._doAppend(e)},o._cleanUp=function(e){for(var t=this._cleanUpTask[e];t&&t.length;){var i=t[0];if(!this._cleanUpRange(e,i))return;t.shift()}this.refresh()},function(e,t,i){return t&&$(e.prototype,t),i&&$(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}(t,[{key:"readyState",get:function(){return this._mediaSource?this._mediaSource.readyState:"closed"}}])}(r.EventEmitter);var re=window.performance,ne=function(){function e(){this.tag="fps",this._lastDroppedFrames=0,this._lastDecodedFrames=0,this._video=null,this._isVideoPlaybackQualityAvailable=!1,this._lastTime=0,this._decoded=0,this._dropped=0}var t=e.prototype;return t.attachMedia=function(e){var t=this._video=e instanceof window.HTMLVideoElement?e:null;t&&(this._isVideoPlaybackQualityAvailable="function"==typeof t.getVideoPlaybackQuality)},t.destory=function(){},t.reset=function(){this._lastTime=re.now(),this._lastDroppedFrames=this._lastDecodedFrames=this._decoded=this._dropped=0;var e=this._video;if(e)try{if(this._isVideoPlaybackQualityAvailable){var t=e.getVideoPlaybackQuality();this._lastDecodedFrames=t.totalVideoFrames,this._lastDroppedFrames=t.droppedVideoFrames}else this._lastDecodedFrames=e.webkitDecodedFrameCount,this._lastDroppedFrames=e.webkitDroppedFrameCount}catch(e){return}},t.getInfo=function(){var e=this._video,t=re.now(),i=0,r=0;if(e)if(this._isVideoPlaybackQualityAvailable){var n=e.getVideoPlaybackQuality();i=n.totalVideoFrames,r=n.droppedVideoFrames}else i=e.webkitDecodedFrameCount||0,r=e.webkitDroppedFrameCount||0;if(i){i<this._lastDecodedFrames&&(this._lastDecodedFrames=0,this._lastDroppedFrames=0);var o=t-this._lastTime,s=r-this._lastDroppedFrames,a=i-this._lastDecodedFrames,u=0,d=0;return this._lastTime&&(u=parseFloat((1e3*s/o).toFixed(2)),d=parseFloat((1e3*a/o).toFixed(2))),this._decoded=this._decoded+=a,this._dropped=this._dropped+=s,this._lastTime=t,this._lastDroppedFrames=r,this._lastDecodedFrames=i,{decoded:this._decoded,dropped:this._dropped,decodedFPS:d,droppedFPS:u}}this._lastTime=t},e}();function oe(){return(oe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)({}).hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(null,arguments)}function se(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,ae(r.key),r)}}function ae(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}var ue=function(){function e(){this._qos=void 0,this.reset()}var t,i,r,n=e.prototype;return n.reset=function(){this._qos={traffic:0,streams:[],download:[]}},n.onKeyFrame=function(){this._qos.streams[this._qos.streams.length-1].keyFrame++},n.onStreamOpen=function(e,t,i,r){this._qos.streams.length>10&&this._qos.streams.shift(),this._qos.streams.push({index:e,startPos:t,url:i,bitrate:r,traffic:0,loadTimeCost:0,keyFrame:0,videoDataRate:0,audioDataRate:0,segments:{}})},n.onMediaInfo=function(e){var t=this.loadingInfo;t&&(t.mediaInfo=oe({},e))},n.onDataReceive=function(e){this._qos.traffic+=e.byteLength;var t=this._qos.download;t.length>200&&t.pop(),t.unshift(e);var i=this._qos.streams[this._qos.streams.length-1];i.traffic+=e.byteLength,i.loadTimeCost+=e.timeCost},n.onMediaSegment=function(e){var t=this._qos,i=t.streams[t.streams.length-1],r=i.segments[e.type]||[];i.segments[e.type]=r,r.push({duration:1e3*(e.endDTS-e.startDTS),dts:1e3*e.startDTS,len:e.payload.byteLength}),r.length>100&&r.shift();for(var n=0,o=0,s=0;s<r.length;s++)o+=r[s].len,n+=r[s].duration;n>0&&("video"===e.type?i.videoDataRate=Math.round(8*o/n):"audio"===e.type&&(i.audioDataRate=Math.round(8*o/n)))},n.getInfoByTime=function(e){for(var t=this._qos.streams.length-1;t>=0;t--)if(this._qos.streams[t].startPos<e)return this._qos.streams[t];return null},n.updateStartPos=function(e){this._qos.streams.length&&(this._qos.streams[this._qos.streams.length-1].startPos=e)},t=e,(i=[{key:"loadingInfo",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1]:null}},{key:"downloadSpeed",get:function(){for(var e=this._qos,t=performance.now(),i=0,r=0,n=0;n<e.download.length&&e.download[n].ts>t-1e3;n++)i+=e.download[n].byteLength,r+=e.download[n].timeCost;return Math.round(i/r*1e3)||0}},{key:"mediaInfo",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].mediaInfo:null}},{key:"videoDataRate",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].videoDataRate:0}},{key:"audioDataRate",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].audioDataRate:0}},{key:"bitrate",get:function(){return this._qos.streams.length?this._qos.streams[this._qos.streams.length-1].bitrate:0}},{key:"traffic",get:function(){return this._qos.traffic}},{key:"data",get:function(){return this._qos}}])&&se(t.prototype,i),r&&se(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}();function de(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,he(r.key),r)}}function he(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function fe(e,t){return(fe=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var _e=function(e){function t(t){var i;return(i=e.call(this)||this)._media=void 0,i._playbackQuality=void 0,i._data=void 0,i._playing=!1,i._sm=void 0,i._hbTimer=void 0,i._heartbeat=function(){i._refresh();var e=i._data,t=i._sm,r={totalReceive:t.traffic,speed:t.downloadSpeed,videoDataRate:t.videoDataRate,audioDataRate:t.audioDataRate,decodedFPS:e.decodedFPS,droppedFPS:e.droppedFPS,decodedFrames:e.decodedFrames,droppedFrames:e.droppedFrames};i.emit(d.a.HEARTBEAT,r)},i._sm=new ue,i._media=t,i.reset(),i}var i,r;r=e,(i=t).prototype=Object.create(r.prototype),i.prototype.constructor=i,fe(i,r);var n=t.prototype;return n.reset=function(){this._data={decodedFPS:0,droppedFPS:0,decodedFrames:0,droppedFrames:0,loadStartTime:0,firstFrameTime:0,blockDuration:0,blockCount:0,downloadedBytes:0},this._sm.reset(),this._playbackQuality&&this._playbackQuality.reset(),this._refresh()},n.onReport=function(e){e.ts=e.ts||performance.now();var t=this._data;switch(e.type){case H:t.downloadedBytes+=e.byteLength,this._sm.onDataReceive(e);break;case j:this._sm.onStreamOpen(e.index||0,e.sync,e.url,e.bitrate);break;case q:this._sm.onKeyFrame()}},n.destroy=function(){this._playbackQuality&&(this._playbackQuality.destory(),this._playbackQuality=void 0),this._stopHeartbeat()},n.onLoad=function(){this._startHeartbeat(),this._media.video&&(this._playbackQuality=new ne,this._playbackQuality.attachMedia(this._media.video))},n.onSegmentInit=function(e){this._sm.onMediaInfo(e)},n.onLoadeddata=function(){this._onFirstFrame(),this._waitingEnd()},n.onCanplay=function(){this._onFirstFrame(),this._waitingEnd()},n.onPlaying=function(){this._playing=!0,this._waitingEnd()},n.onEnd=function(){this._waitingEnd()},n.onWaiting=function(e){this._playing&&this._data.firstFrameTime&&e&&this._waitingStart()},n.onStopLoad=function(){this._stopHeartbeat()},n.onSegment=function(e){var t=this;e.segments.forEach((function(e){t._sm.onMediaSegment(e)}))},n._refresh=function(){var e;this._playbackQuality&&(e=this._playbackQuality.getInfo());var t=this._data;e?(t.decodedFPS=e.decodedFPS,t.droppedFPS=e.droppedFPS,t.droppedFrames=e.dropped,t.decodedFrames=e.decoded):t.decodedFPS=t.droppedFPS=t.droppedFrames=t.decodedFrames=0},n._onFirstFrame=function(){this._data.firstFrameTime||(this._data.firstFrameTime=performance.now())},n._waitingStart=function(){this._data.bufferingStartMS||(this._data.blockCount++,this._data.bufferingStartMS=this._data.bufferingStartMS||performance.now())},n._waitingEnd=function(){this._data.bufferingStartMS&&(this._data.blockDuration+=performance.now()-this._data.bufferingStartMS),this._data.bufferingStartMS=null},n._startHeartbeat=function(){this._hbTimer||(this._hbTimer=setInterval(this._heartbeat,1e3))},n._stopHeartbeat=function(){this._hbTimer&&(clearInterval(this._hbTimer),this._hbTimer=void 0)},function(e,t,i){return t&&de(e.prototype,t),i&&de(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}(t,[{key:"data",get:function(){return this._data}}])}(r.EventEmitter),ce=i(6);var le=function(){function e(e,t){this.tag="PlaybackRateManager",this._media=void 0,this._config=void 0,this._interval=0,this._timer=void 0,this._media=e,this._config=t}var t=e.prototype;return t.start=function(){this._interval=this._interval||this._config.startDelay||this._config.interval||5,this._tick(),this._interval=this._config.interval||1},t.stop=function(){this._timer&&(clearTimeout(this._timer),this._timer=0)},t.destroy=function(){this._timer&&(clearTimeout(this._timer),this._timer=0)},t._tick=function(){var e=this;this._timer||(this._timer=setTimeout((function(){e._media.video&&e._nextPlayBackRate(e._media.bufferedSec(),e._media.video),e._timer=0,e._tick()}),1e3*this._interval))},t._nextPlayBackRate=function(e,t){var i=1,r=this._config.rule,o=0;for(o=0;o<r.length&&!(t.playbackRate>=r[o].rate);o++);var s=o<r.length-1?r[o+1]:null,a=o>0?r[o-1]:null;i=r[o].rate,a&&e>a.lower&&(i=a.rate),s&&e<s.upper&&(i=s.rate),t.playbackRate!==i&&(n.b.i(this.tag,"auto change playback rate from "+t.playbackRate+" to "+i),t.playbackRate=i)},e}();function pe(){return(pe=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)({}).hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e}).apply(null,arguments)}function ve(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,me(r.key),r)}}function me(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function ge(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ye(e,t){return(ye=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var be=function(e){return e[e.NONE=0]="NONE",e[e.WAITING=1]="WAITING",e[e.SEEK=2]="SEEK",e[e.SELECT_BITRATE=3]="SELECT_BITRATE",e[e.INIT=4]="INIT",e}(be||{}),Ee=function(e){function t(i){var r;return(r=e.call(this)||this).tag="las",r._config=void 0,r._src=void 0,r._video=void 0,r._mse=void 0,r._lasMain=void 0,r._stat=be.INIT,r._audioCodecSwap=!1,r._error=void 0,r._audioCodec="",r._recoverMediaErrorTime=0,r._mainTimer=void 0,r._media=void 0,r._nextLevel=[],r._mediaInfo=void 0,r._loadStopped=!1,r._seekOnUpdateEnd=!1,r._playingLevel=void 0,r._startLevel=void 0,r._monitor=void 0,r._playbackRateManager=void 0,r._onVideoLoadeddata=function(){n.b.i(r.tag,"loadeddata"),r._monitor.onLoadeddata()},r._onVideoCanplay=function(){n.b.v(r.tag,"canplay "+!!r._stat),r._monitor.onCanplay(),r._video&&r._stat!==be.NONE&&(r._stat=be.NONE,r._checkLevelChange(),r._video.paused||r._onVideoPlaying())},r._onVideoWaiting=function(){if(r._video){r._stat=r._stat||be.WAITING;var e=!r._video.seeking&&r._stat===be.WAITING;e&&n.b.i(r.tag,"waiting currentTime:",r._video.currentTime),r._monitor.onWaiting(e)}},r._onVideoPlaying=function(){n.b.i(r.tag,"playing"),r._error||(r._stat=be.NONE,r._monitor.onPlaying())},r._onVideoEnded=function(){r._monitor.onEnd(),r._mse&&r._mse.flush()},r._onVideoError=function(e){if(n.b.e(r.tag,"video error",e),!r._error){if(r._config.autoRecoverMedia){var t=performance.now();if((!r._recoverMediaErrorTime||t-r._recoverMediaErrorTime>3e3)&&r._recoverSwapRemuxType())return void(r._recoverMediaErrorTime=t);if(r._recoverSwapAudioCodec())return}var i="video error";r._video&&r._video.error&&(i+=" code:"+r._video.error.code+" message:"+r._video.error.message),r._onError({type:u.b.MEDIA_ERROR,details:u.a.VIDEO_ERROR,fatal:!0,info:{reason:i}})}},r._resetMSE=function(){r._seekOnUpdateEnd=!1,r._video&&(n.b.i(r.tag,"rebuild mse"),URL.revokeObjectURL(r._video.src),r._video.src="",r._video.removeAttribute("src"),r._destroyMSE(),r._initMSE())},r._mainLoop=function(){var e=r._video;if(e&&(r._stat===be.WAITING&&!e.seeking||r._stat===be.INIT||r._stat===be.SEEK||r._stat===be.SELECT_BITRATE)&&r._mse&&!r._mse.hasCleanUpTask()&&!e.ended){var t=e.currentTime,i=r._media.currentBuffer(t),o=void 0;if(!i||i.end-t<1){var s=r._media.nextBuffer(t);s&&(n.b.i(r.tag,"try fix block-A"),o=s.start)}else e.buffered.length>1&&i.end-t>1&&(n.b.i(r.tag,"try fix block-B"),o=i.start);o&&(o+=ce.a.isSafari?.3:.001,r._internalSeek(o),n.b.i(r.tag,"jump to "+o))}r._nextLevel.length&&r._checkLevelChange()},r.off||(r.off=r.removeListener),r._config=a.processConfig(i),r._media=new J,r._config?t.isSupported()?(r._mainTimer=null,r._stat=be.INIT,r._startMainTimer(),r._initMonitor(),r._config.autoPlaybackRateConf&&(r._playbackRateManager=new le(r._media,r._config.autoPlaybackRateConf)),n.b.i(r.tag,t.version,r._config),r):(setTimeout((function(){r._onError({type:u.b.OTHER_ERROR,details:u.a.UNSUPPORTED,fatal:!0,info:{reason:"unsupported"}})}),0),ge(r)):(setTimeout((function(){r._onError({type:u.b.OTHER_ERROR,details:u.a.CONFIG_ERROR,fatal:!0,info:{reason:"config data error"}})}),0),ge(r))}var i,r;r=e,(i=t).prototype=Object.create(r.prototype),i.prototype.constructor=i,ye(i,r),t.isSupported=function(){return e=window.MediaSource||window.WebKitMediaSource,t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove,n=g.isSupported()||b.isSupportedChunk()===y.MOZ_CHUNK,i&&r&&n;var e,t,i,r,n};var o=t.prototype;return o.attachMedia=function(e){this._video=e,this._media.attachVideo(this._video),this._initMSE(),this._bindVideoEvents()},o.load=function(e){void 0===e&&(e=void 0),this._video||this._onError({type:u.b.OTHER_ERROR,details:u.a.NO_VIDEO,fatal:!0,info:{reason:"no video attached"}}),this._playingLevel=void 0,this._monitor.reset(),e&&(this._src=e),this._load()},o.resume=function(){n.b.i(this.tag,"call resume"),this._loadStopped&&(this._loadStopped=!1,this._load()),this._video&&this._video.paused&&this._video.play()},o.destroy=function(){this._playbackRateManager&&this._playbackRateManager.destroy(),this._stopMonitor(),this._stopMainTimer(),this._unbindVideoEvents(),this._stopVideo(),this.removeAllListeners()},o.refresh=function(e){void 0===e&&(e=!1),n.b.i(this.tag,"call refresh"),(this._config.autoRecoverMedia||this._error!==u.a.VIDEO_ERROR||!this._recoverSwapRemuxType()&&!this._recoverSwapAudioCodec())&&this._reload(e),this._error=void 0},o.stopLoad=function(){n.b.i(this.tag,"call stopLoad"),this._lasMain&&(this._destroyLasMain(),this._mse.endOfData(),this._loadStopped=!0,this._monitor.onStopLoad()),this._playbackRateManager&&this._playbackRateManager.stop()},o.getMediaInfo=function(){return pe({},this._mediaInfo)},o._reload=function(e){void 0===e&&(e=!1),this._lasMain&&this._mse||this._error?(this._lasMain&&(this._startLevel=this._lasMain.currentLevel),this._nextLevel=[],e&&this._mse?(this._mse.flush(),this._internalSeek(0),this._seekOnUpdateEnd=!0):(this._stopVideo(),this._initMSE()),this._destroyLasMain(),this._initLasMain(),this._lasMain&&this._lasMain.load()):n.b.v(this.tag,"transmuxer & mediaSource not ready")},o._bindVideoEvents=function(){this._video&&(this._video.addEventListener("loadeddata",this._onVideoLoadeddata),this._video.addEventListener("canplay",this._onVideoCanplay),this._video.addEventListener("waiting",this._onVideoWaiting),this._video.addEventListener("playing",this._onVideoPlaying),this._video.addEventListener("ended",this._onVideoEnded),this._video.addEventListener("error",this._onVideoError))},o._unbindVideoEvents=function(){this._video&&(this._video.removeEventListener("loadeddata",this._onVideoLoadeddata),this._video.removeEventListener("canplay",this._onVideoCanplay),this._video.removeEventListener("waiting",this._onVideoWaiting),this._video.removeEventListener("playing",this._onVideoPlaying),this._video.removeEventListener("ended",this._onVideoEnded),this._video.removeEventListener("error",this._onVideoError))},o._initMSE=function(){var e=this;if(this._video){var t=this._video;this._mse=new ie(this._config),this._mse.attach(t),this._media.attachMSE(this._mse),this._mse.on(d.a.ERROR,(function(t){e._onError(t)})),this._mse.on("updateend",(function(){e._seekOnUpdateEnd&&t.buffered.length&&(n.b.i(e.tag,"seek on updateend"),e._internalSeek(t.buffered.start(0)),e._seekOnUpdateEnd=!1)})),this._mse.on("resetDone",(function(){e._seekOnUpdateEnd=!0}))}},o._destroyMSE=function(){this._mse&&(this._mse.removeAllListeners(),this._mse.destroy())},o._load=function(){this._loadStopped=!1,this._error=void 0,this._stat=be.INIT,this._nextLevel=[],this._media.reset(),this._monitor.onLoad(),this._lasMain&&this._destroyLasMain(),(this._mse.hasSourceBuffer()||this._video&&this._video.error)&&this._resetMSE(),this._initLasMain(),this._lasMain&&this._lasMain.load(),this._config.autoPlaybackRate&&this._playbackRateManager&&this._playbackRateManager.start()},o._verifyLevel=function(e){return!(!(this._lasMain&&this._lasMain.levels.length>0&&e<this._lasMain.levels.length&&e>=-1&&this._video)||this._video.ended)},o._initLasMain=function(){this._lasMain=new X(this._config,this._media),this._bindLasMainEvent(this._lasMain),this._lasMain.init(this._src,this._audioCodec)},o._destroyLasMain=function(){this._lasMain&&(this._lasMain.removeAllListeners(),this._lasMain.destroy(),this._lasMain=void 0)},o._bindLasMainEvent=function(e){var t=this,i=this._mse;e.on(d.a.MP4_SEGMENT,(function(e){i&&i.mediaSegment(e.segments),t._monitor&&t._monitor.onSegment(e)})),e.on(d.a.MEDIA_INFO,(function(e){var r=pe({},e);t._monitor.onSegmentInit(r),t.emit(d.a.MEDIA_INFO,r),t._mediaInfo=r,t._audioCodec=e.defaultAudioCodec||e.audioCodec,i&&i.mediaInit(r)})),e.on(d.a.ERROR,(function(e){t._onError(e)})),e.on(d.a.LOAD_END,(function(){i&&i.endOfData(),t.emit(d.a.LOAD_END)})),e.on(d.a.LEVEL_SWITCH_FAILED,(function(e){t.emit(d.a.LEVEL_SWITCH_FAILED,e)})),e.on(d.a.LEVEL_SWITCHING,(function(e){!e.smooth&&t._mse&&t._mse.flush(),t.emit(d.a.LEVEL_SWITCHING,{level:e.level}),t._nextLevel=t._nextLevel.sort((function(e,t){return e.startSec-t.startSec})).filter((function(t){return t.startSec<e.startSec})),t._nextLevel.push(e)})),e.on(d.a.SCRIPT_PARSED,(function(e){t.emit(d.a.SCRIPT_PARSED,e)})),e.on(d.a.MANIFEST_PARSED,(function(i){"number"!=typeof t._playingLevel?("number"==typeof t._startLevel&&(e.currentLevel=t._startLevel),i=pe({levels:t.levels.slice(0),currentLevel:t.currentLevel},i),t._playingLevel=e.currentLevel,n.b.i(t.tag,d.a.MANIFEST_PARSED,i),t.emit(d.a.MANIFEST_PARSED,i)):e.currentLevel=t._playingLevel})),e.on(d.a.REPORT,(function(e){t._monitor&&t._monitor.onReport(e)}))},o._internalSeek=function(e){this._video&&(this._video.currentTime=e)},o._onError=function(e){n.b.i(this.tag,"on error "+JSON.stringify(e)),!e.info.url&&this.levels&&this.levels[this.currentLevel]&&(e.info.url=this.levels[this.currentLevel].url),e.fatal&&(this.stopLoad(),this._stopMainTimer(),(e.details===u.a.VIDEO_ERROR||this._video&&this._video.error)&&this._destroyMSE(),this._error||(this._error=e.details,this.emit(d.a.ERROR,e)))},o._startMainTimer=function(){null===this._mainTimer&&(this._mainTimer=setInterval(this._mainLoop,200))},o._stopMainTimer=function(){this._mainTimer&&(clearInterval(this._mainTimer),this._mainTimer=null)},o._checkLevelChange=function(){var e=this._nextLevel[0];this._video&&e&&this._video.currentTime>=e.startSec&&this._media.isTimeinBuffered(this._video.currentTime)&&(this.emit(d.a.LEVEL_SWITCHED,{level:e.level}),this._playingLevel=e.level,this._nextLevel.shift())},o._stopVideo=function(){this._video&&(URL.revokeObjectURL(this._video.src),this._video.src="",this._video.removeAttribute("src"),this._destroyLasMain(),this._destroyMSE())},o._initMonitor=function(){var e=this;this._monitor||(this._monitor=new _e(this._media),this._monitor.on(d.a.HEARTBEAT,(function(t){e.emit(d.a.HEARTBEAT,t)})))},o._stopMonitor=function(){this._monitor&&(this._monitor.destroy(),this._monitor.removeAllListeners())},o._recoverSwapRemuxType=function(){var e=this._config.gopRemux;return this._config.gopRemux=!0,e!==this._config.gopRemux&&(n.b.i(this.tag,"recover swap remux type"),this._reload(),!0)},o._recoverSwapAudioCodec=function(){return!(this._audioCodecSwap||!this._audioCodec)&&(-1!==this._audioCodec.indexOf("mp4a.40.5")?this._audioCodec="mp4a.40.2":this._audioCodec="mp4a.40.5",this._audioCodecSwap=!0,n.b.i(this.tag,"recover swap audio codec"),this._reload(),!0)},function(e,t,i){return t&&ve(e.prototype,t),i&&ve(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}(t,[{key:"autoLevelEnabled",get:function(){return!!this._lasMain&&this._lasMain.autoLevelEnabled}},{key:"levels",get:function(){return this._lasMain&&this._lasMain.levels.slice(0),[]}},{key:"nextLevel",get:function(){return this._lasMain?this._lasMain.nextLevel:0},set:function(e){this._verifyLevel(e)&&this._lasMain?this._lasMain.nextLevel=e:this.emit(d.a.LEVEL_SWITCH_FAILED,{level:e})}},{key:"currentLevel",get:function(){return this._lasMain?this._lasMain.currentLevel:0},set:function(e){this._verifyLevel(e)&&this._lasMain?-1===e?this._lasMain.nextLevel=e:(this._stat=be.SELECT_BITRATE,this._seekOnUpdateEnd=!0,this._mse&&this._mse.flush(),this._lasMain.currentLevel=e):this.emit(d.a.LEVEL_SWITCH_FAILED,{level:e})}},{key:"startLevel",get:function(){return void 0===this._startLevel?-1:this._startLevel},set:function(e){this._startLevel=e}},{key:"monitorData",get:function(){if(this._monitor)return this._monitor.data}}],[{key:"version",get:function(){return"1.0.6"}},{key:"Events",get:function(){return d.a}},{key:"ErrorTypes",get:function(){return u.b}},{key:"ErrorDetails",get:function(){return u.a}}])}(r.EventEmitter)}]).default}));
//# sourceMappingURL=index.min.js.map